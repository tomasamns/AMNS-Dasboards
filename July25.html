<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Class for dark mode toggling -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AM/NS India - ESG Pulse Monitor</title>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Libraries for Downloading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Tailwind config for dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
             overflow-x: hidden;
        }
        .filter-btn, .energy-tab-btn {
            background-color: #E5E7EB; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .dark .filter-btn, .dark .energy-tab-btn {
            background-color: #4B5563; /* gray-600 */
            color: #F3F4F6; /* gray-100 */
        }
        .filter-btn:hover, .energy-tab-btn:hover {
            background-color: #D1D5DB; /* gray-300 */
            transform: translateY(-2px);
        }
        .dark .filter-btn:hover, .dark .energy-tab-btn:hover {
             background-color: #6B7280; /* gray-500 */
        }
        .filter-btn.active, .energy-tab-btn.active {
            background-color: #10B981; /* green-500 */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .time-filter-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 9999px; /* pill shape */
            font-weight: 600;
            transition: all 0.2s;
            background-color: transparent;
            color: #374151;
            border: none;
        }
        .dark .time-filter-btn {
            color: #F3F4F6;
        }
        .time-filter-btn:hover:not(.active) {
            background-color: #D1D5DB;
        }
        .dark .time-filter-btn:hover:not(.active) {
            background-color: #4B5563;
        }
        .time-filter-btn.active {
            background-color: #10B981;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .re-toggle-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            line-height: 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-300">

    <div id="dashboard-container" class="p-6 sm:p-10">
        <!-- BETA Overlay -->
        <div id="beta-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="beta-modal">
                <h3 class="text-2xl font-bold text-yellow-500 mb-4">BETA Testing</h3>
                <p class="text-gray-700 dark:text-gray-300 mb-6">This dashboard is currently in a testing phase. The data displayed is for demonstration purposes only and should not be used for official reference.</p>
                <button id="dismiss-beta" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Acknowledge & Continue</button>
            </div>
        </div>

        <!-- Header Section -->
        <header class="relative text-center mb-12">
            <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-700 dark:text-gray-300 tracking-wider mb-2">AM/NS INDIA</h2>
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-2 text-gray-900 dark:text-white">
                ESG Pulse Monitor
            </h1>
            <p id="overview-subtitle" class="text-xl text-gray-500 dark:text-gray-400">August 2025 Overview</p>
            <div id="dynamic-greeting" class="flex items-center justify-center gap-2 text-lg text-gray-500 dark:text-gray-400 mt-1"><svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10V3M12 21v-2m-7.07-2.93l1.41-1.41M4.93 4.93l1.41 1.41M21 12h-2M5 12H3m15.07 4.07l-1.41-1.41M17.66 6.34l-1.41 1.41M4 16h16"></path></svg><span>Good Evening</span></div>

            <!-- Left side buttons -->
            <div class="absolute top-0 left-0 flex items-center gap-3">
                <!-- Download Button -->
                <div class="relative">
                    <button id="download-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                    </button>
                    <div id="download-menu" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-20">
                        <a href="#" id="download-png" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Download as PNG</a>
                        <a href="#" id="download-pdf" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Download as PDF</a>
                    </div>
                </div>
                <!-- Share Button -->
                <button id="share-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
            </div>

            <!-- Right side buttons -->
            <div class="absolute top-0 right-0 flex items-center gap-3">
                <!-- Custom Month Popover -->
                <div class="relative">
                    <button id="month-popover-btn" aria-expanded="false" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 ring-2 ring-indigo-300/60 hover:ring-indigo-500 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transition">
                        <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </button>
                    <div id="month-popover" class="hidden absolute right-0 mt-3 w-80 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl p-4 z-50">
                        <div id="month-popover-content"></div>
                    </div>
                </div>

                <!-- Theme Toggle Button -->
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="theme-icon-dark" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Filter Buttons for Monthly, Quarterly, YTD -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex p-1 bg-gray-200 dark:bg-gray-700 rounded-full">
                <button id="filter-monthly" class="time-filter-btn active">Monthly</button>
                <button id="filter-quarterly" class="time-filter-btn">Quarterly</button>
                <button id="filter-ytd" class="time-filter-btn">YTD</button>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
            
            <!-- CO2 Intensity Card -->
            <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col">
                <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                    <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">FY26 Data is Unaudited, Do not Share Externally</p>
                </div>
                <div class="absolute top-4 right-4 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                        Placeholder for CO2 Intensity information.
                        <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                    </div>
                </div>
                <div>
                     <div class="flex justify-center mb-2">
                        <svg id="fi_4038678" enable-background="new 0 0 512 512" height="512" viewBox="0 0 512 512" width="512" xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-cyan-600 dark:text-cyan-400" fill="currentColor"><g><g><path d="m181.044 74.914c0-15.933 12.962-28.896 28.896-28.896h134.993c25.375 0 46.018-20.644 46.018-46.018h-29.904c0 8.885-7.229 16.114-16.114 16.114h-134.993c-32.422 0-58.8 26.377-58.8 58.8v20.78h29.904z"></path><path d="m461.435 48.263h7.411c7.306 0 13.249 5.944 13.249 13.25 0 7.305-5.944 13.248-13.249 13.248h-131.293c-24.69 0-44.776 20.087-44.776 44.776 0 24.69 20.086 44.777 44.776 44.777h50.956v-29.904h-50.956c-8.201 0-14.872-6.672-14.872-14.873 0-8.2 6.672-14.872 14.872-14.872h131.293c23.795 0 43.154-19.358 43.154-43.152 0-23.795-19.359-43.154-43.154-43.154h-7.411c-4.288 0-7.776-3.489-7.776-7.777v-10.582h-29.904v10.582c0 20.777 16.903 37.681 37.68 37.681z"></path><path d="m235.662 373.547c3.092 5.115 7.364 9.096 12.816 11.943 5.451 2.848 11.576 4.272 18.374 4.272 6.247 0 11.82-1.102 16.72-3.308 4.899-2.205 8.942-5.388 12.127-9.554l-13.688-12.219c-3.982 5.023-8.668 7.533-14.056 7.533-4.533 0-8.176-1.454-10.933-4.364-2.756-2.909-4.134-6.813-4.134-11.713 0-4.899 1.378-8.804 4.134-11.713s6.399-4.364 10.933-4.364c5.389 0 10.074 2.512 14.056 7.533l13.688-12.219c-3.185-4.165-7.228-7.35-12.127-9.555-4.9-2.205-10.473-3.307-16.72-3.307-6.799 0-12.923 1.424-18.374 4.271-5.452 2.848-9.724 6.831-12.816 11.943-3.094 5.115-4.639 10.919-4.639 17.41 0 6.495 1.546 12.298 4.639 17.411z"></path><path d="m315.635 385.444c5.512 2.878 11.727 4.318 18.65 4.318 6.92 0 13.138-1.44 18.65-4.318s9.83-6.875 12.953-11.989c3.124-5.114 4.686-10.887 4.686-17.317 0-6.431-1.562-12.203-4.686-17.318-3.123-5.113-7.441-9.109-12.953-11.989-5.512-2.878-11.729-4.318-18.65-4.318-6.922 0-13.138 1.44-18.65 4.318-5.513 2.879-9.83 6.875-12.954 11.989-3.123 5.115-4.685 10.887-4.685 17.318 0 6.43 1.562 12.204 4.685 17.317 3.123 5.115 7.441 9.112 12.954 11.989zm6.155-37.804c1.286-2.419 3.016-4.286 5.191-5.604 2.173-1.316 4.608-1.975 7.304-1.975 2.695 0 5.129.659 7.304 1.975 2.173 1.318 3.904 3.185 5.191 5.604 1.286 2.42 1.929 5.253 1.929 8.498 0 3.247-.643 6.079-1.929 8.498-1.286 2.42-3.018 4.288-5.191 5.604-2.175 1.318-4.609 1.975-7.304 1.975-2.696 0-5.13-.657-7.304-1.975-2.175-1.316-3.904-3.184-5.191-5.604-1.286-2.419-1.929-5.251-1.929-8.498-.001-3.246.643-6.078 1.929-8.498z"></path><path d="m386.021 385.047c1.028-.624 2.13-.937 3.306-.937 1.212 0 2.14.267 2.783.799.642.533.964 1.276.964 2.231 0 .772-.202 1.562-.606 2.369-.404.809-1.212 1.782-2.424 2.921l-13.942 12.894v7.99h30.914v-10.084h-13.005l5.511-5.015c2.608-2.35 4.362-4.454 5.262-6.309.899-1.854 1.35-3.848 1.35-5.979 0-2.388-.661-4.499-1.983-6.337-1.322-1.837-3.16-3.251-5.511-4.243s-5.052-1.487-8.1-1.487c-4.004 0-7.421.799-10.249 2.396-2.829 1.598-4.978 3.775-6.447 6.53l9.809 4.904c.55-1.136 1.339-2.018 2.368-2.643z"></path></g><path d="m469.819 366.179c0-80.406-65.415-145.821-145.821-145.821-37.026 0-70.867 13.879-96.612 36.698l-7.972-101.122h29.151v-29.904h-182.144v29.904h31.036l-20.145 326.162h-77.312v29.904h510.362v-29.904h-98.004c34.9-26.667 57.461-68.704 57.461-115.917zm-145.821-115.917c63.917 0 115.917 52 115.917 115.917s-52 115.917-115.917 115.917-115.917-52-115.917-115.917 52-115.917 115.917-115.917zm-134.581-94.327 2.358 29.904h-66.203l1.847-29.904zm-82.143 326.161 16.451-266.353h70.408l5.823 73.86c-13.799 22.27-21.778 48.507-21.778 76.576 0 47.213 22.561 89.25 57.46 115.917z"></path></g></svg>
                    </div>
                    <h2 class="text-xl font-semibold mb-2 text-cyan-600 dark:text-cyan-400 text-center">CO2 Intensity</h2>
                    <p class="text-5xl font-bold mb-1 text-center">
                        <span id="co2-intensity-value">2.13</span> 
                        <span class="text-2xl text-gray-500 dark:text-gray-400">tCO₂/tcs</span>
                    </p>
                    <p id="co2-intensity-subtitle" class="text-md text-gray-500 dark:text-gray-400 mb-2 text-center">vs Target: 2.09 tCO₂/tcs</p>
                </div>
                <div class="flex-grow">
                    <canvas id="co2LineChart"></canvas>
                </div>
            </div>

            <!-- Crude Steel Production Card -->
            <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col justify-between">
                <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                    <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">FY26 Data is Unaudited, Do not Share Externally</p>
                </div>
                <div class="absolute top-4 right-4 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                        Placeholder for Crude Steel Production information.
                        <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                    </div>
                </div>
                <div>
                     <div class="flex justify-center mb-2">
                        <svg id="fi_1503973" class="w-8 h-8 text-lime-600 dark:text-lime-400" fill="currentColor" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="009---Molten-Metal-Mould" fill="currentColor" fill-rule="nonzero"><path d="M1,60 L47,60 C47.5522847,60 48,59.5522847 48,59 L48,52 C48,51.983 47.991,51.97 47.99,51.953 C47.9859098,51.8463819 47.9649847,51.7410814 47.928,51.641 C47.928,51.629 47.922,51.616 47.917,51.605 C47.8786427,51.5142533 47.8270858,51.4296731 47.764,51.354 L37.364,39.062 C36.7935387,38.3879215 35.9550671,37.9994151 35.072,38 L28.381,38 C29.2902562,36.237157 30.3583439,34.5608853 31.572,32.992 C31.772,33.022 31.992,33.042 32.221,33.055 L36.8,33.5 C37.2129031,34.2468958 37.9428635,34.7656681 38.784,34.91 C38.861,34.922 38.937,34.922 39.014,34.928 C39.039,34.928 39.06,34.943 39.086,34.943 L44.977,35 L45.055,35 C45.6960756,34.9880293 46.3223214,34.8050579 46.869,34.47 L48.201,34.614 C48.237194,34.6180195 48.2735835,34.6200226 48.31,34.62 L48.363,34.62 L48.436,34.62 C52.936,34.281 57.318,29.673 59.092,23.42 C60.784,17.447 59.71,11.608 56.436,8.733 C56.1637229,7.65579335 55.4195744,6.7591403 54.411,6.293 C54.405,6.293 54.402,6.286 54.396,6.283 L50.335,4.47 C49.5713879,4.00605309 48.6315853,3.93650696 47.808,4.283 L41.819,1.292 C41.7910981,1.27910214 41.7623678,1.26807772 41.733,1.259 C41.1261443,0.879710262 40.4695338,0.586574568 39.782,0.388 C36.8,-0.457 33.532,0.496 30.582,3.073 C29.1822383,4.32052767 27.9763129,5.76979523 27.004,7.373 L9.35,0.079 L9.344,0.079 C9.29083404,0.062654135 9.23626724,0.0512721029 9.181,0.045 C9.10934781,0.0214045551 9.03517364,0.00630121674 8.96,0 L1,0 C0.44771525,7.3207812e-17 6.76353751e-17,0.44771525 0,1 L0,4.194 C0.00023757104,4.32484046 0.0264085937,4.45433604 0.077,4.575 C0.11052377,4.64070548 0.15181964,4.70214567 0.2,4.758 C0.227049501,4.80599446 0.257809891,4.85180069 0.292,4.895 C0.384845611,4.98773338 0.494904737,5.06144582 0.616,5.112 L24.016,14.788 C23.0792856,18.5643767 23.2042155,22.526144 24.377,26.236 C22.9438618,30.0241691 21.9871931,33.975802 21.529,38 L12.929,38 C12.0462824,37.9997094 11.2082355,38.3881886 10.638,39.062 L0.236,51.354 C0.172914158,51.4296731 0.121357263,51.5142533 0.083,51.605 C0.078,51.616 0.077,51.629 0.073,51.64 C0.035220666,51.7402425 0.0139446027,51.8459474 0.01,51.953 C0.01,51.97 1.66880398e-15,51.983 1.66880398e-15,52 L1.66880398e-15,59 C-1.40599316e-16,59.2652165 0.10535684,59.5195704 0.292893219,59.7071068 C0.480429597,59.8946432 0.73478351,60 1,60 Z M46,58 L2,58 L2,53 L46,53 L46,58 Z M17.282,45 C18.4852682,44.5171813 19.7580041,44.2298874 21.052,44.149 C21.032,44.705 21.029,45.276 21.021,45.843 C19.7374544,45.7648165 18.4749148,45.4801626 17.282,45 Z M26.357,26.633 C27.0063433,24.9821447 27.8250511,23.4030406 28.8,21.921 C29.0710979,21.5001178 29.3718605,21.099101 29.7,20.721 C29.754,20.68 31.736,19.258 39.279,22.011 C38.4510528,23.5482777 37.2938313,24.8837433 35.89,25.922 C34.8088272,26.6285761 33.8064436,27.4489215 32.9,28.369 C32,29.318 31.154,30.294 30.38,31.269 C28.570994,33.5080345 27.0600557,35.9722591 25.885,38.6 L25.877,38.618 C24.8322394,40.9497748 24.2141122,43.4500167 24.052,46 C23.6993333,46 23.3546667,45.995 23.018,45.985 C23.112,38.461 24.227,31.948 26.357,26.634 L26.357,26.633 Z M40.987,17.917 C40.7611093,18.6975338 40.4828106,19.4619366 40.154,20.205 C33.11,17.605 30.064,18.247 28.89,18.863 C28.950682,17.4446636 29.1761985,16.0382056 29.562,14.672 C31.171,9 35.156,4.953 38.245,5.821 C41.339,6.7 42.6,12.244 40.987,17.918 L40.987,17.917 Z M45.245,5.237 L49.99,7.609 C50.2372372,8.84280457 50.3046021,10.1058973 50.19,11.359 C49.7998918,15.1168143 48.8276011,18.7910745 47.308,22.25 C46.1216453,25.3855225 44.4195256,28.3006899 42.272,30.875 C41.9411457,31.2476478 41.5828072,31.5949553 41.2,31.914 L37.8,31.585 C41.4,29.434 44.52,25.11 46.066,19.663 C47.593,14.253 47.153,8.958 45.245,5.238 L45.245,5.237 Z M26.271,44.085 C27.7955147,44.1368361 29.3001914,44.4469009 30.721,45.002 C29.2237213,45.5750418 27.6396799,45.8885359 26.037,45.929 C26.0814649,45.310541 26.1595806,44.6949626 26.271,44.085 Z M45.039,33 L45.01,33 L43.015,32.98 C43.322,32.689 43.579,32.416 43.767,32.205 C46.0484272,29.4548465 47.8674962,26.3520267 49.153,23.018 C50.7541399,19.3688572 51.7760979,15.4922321 52.182,11.528 C52.3065354,10.1500601 52.2453208,8.7616333 52,7.4 L53.588,8.107 C53.5943247,8.10653296 53.6006753,8.10653296 53.607,8.107 C53.613,8.107 53.617,8.115 53.623,8.117 C54.1419502,8.39730047 54.500596,8.90347174 54.593,9.486 C54.601,9.522 54.611,9.556 54.622,9.586 C54.8384809,10.7544128 54.8883095,11.9476061 54.77,13.13 C54.5013362,16.1750168 53.7853076,19.1638043 52.645,22 C51.6522563,24.7505825 50.2825195,27.3500536 48.575,29.724 C48.466,29.872 48.348,30.038 48.222,30.213 C47.426,31.323 46.228,33 45.039,33 Z M57.168,22.867 C55.739,27.907 52.368,31.825 48.993,32.523 C49.311,32.123 49.593,31.723 49.849,31.373 L50.183,30.911 C51.9993763,28.3889022 53.4575719,25.6273159 54.516,22.705 C55.7233818,19.6878793 56.4801568,16.5094917 56.762,13.272 C56.776,13.072 56.792,12.823 56.806,12.546 C58.1192067,15.840401 58.2471672,19.4886885 57.168,22.867 Z M31.9,4.579 C34.323,2.462 36.926,1.658 39.238,2.312 C44.168,3.712 46.366,11.248 44.138,19.117 C42.238,25.817 37.638,30.762 33.159,31.056 C33.543,30.614 33.9396667,30.176 34.349,29.742 C35.158603,28.9250411 36.0526078,28.1962948 37.016,27.568 C38.9918549,26.0987192 40.5642287,24.1538052 41.587,21.914 C41.599,21.888 41.609,21.861 41.621,21.835 C42.1515022,20.7524145 42.5832523,19.6241747 42.911,18.464 C44.879,11.518 43.07,5.121 38.79,3.899 C34.51,2.677 29.605,7.185 27.637,14.129 C26.9782932,16.3904483 26.741015,18.7537393 26.937,21.101 C26.474057,21.8213004 26.0484941,22.5649508 25.662,23.329 C25.1612202,20.2324741 25.3611236,17.0630656 26.247,14.054 C27.191573,10.4221917 29.1526489,7.13523002 31.9,4.579 Z M8.761,2 L26.021,9.134 C25.4277053,10.3283084 24.9320859,11.5686944 24.539,12.843 L2,3.521 L2,2 L8.761,2 Z M12.161,40.354 C12.3518301,40.1285041 12.6325963,39.9989197 12.928,40 L21.328,40 C21.2613333,40.7 21.2066667,41.4096667 21.164,42.129 C18.532,42.362 15,43.04 15,45 C15,47.071 18.982,47.708 21.583,47.9 C21.7130247,47.9633988 21.8553634,47.9975328 22,48 C22.0908014,47.9948798 22.18039,47.9766926 22.266,47.946 C22.801,47.979 23.366,48 24,48 C24.31,48 24.61,47.991 24.91,47.982 C24.9396743,47.9895268 24.9697134,47.9955346 25,48 C25.0398186,47.9946054 25.0792377,47.986588 25.118,47.976 C27.557,47.9 33,47.443 33,45 C33,43.04 29.494,42.352 26.735,42.114 C26.9435869,41.3973191 27.1885715,40.6917369 27.469,40 L35.069,40 C35.3633557,39.999805 35.6428462,40.1293072 35.833,40.354 L44.844,51 L3.156,51 L12.161,40.354 Z" id="Shape"></path><path d="M16,32 C17.6568542,32 19,30.6568542 19,29 C19,27.3431458 17.6568542,26 16,26 C14.3431458,26 13,27.3431458 13,29 C13,30.6568542 14.3431458,32 16,32 Z M16,28 C16.5522847,28 17,28.4477153 17,29 C17,29.5522847 16.5522847,30 16,30 C15.4477153,30 15,29.5522847 15,29 C15,28.4477153 15.4477153,28 16,28 Z" id="Shape"></path><circle id="Oval" cx="10" cy="24" r="1"></circle><circle id="Oval" cx="13" cy="19" r="1"></circle></g></g></svg>
                    </div>
                    <h2 class="text-xl font-semibold mb-2 text-lime-600 dark:text-lime-400 text-center">Crude Steel Production</h2>
                    <div class="flex items-baseline justify-center">
                        <p class="text-5xl font-bold mb-1">
                            <span id="cs-production-value">0.62</span> 
                        </p>
                        <div class="relative ml-2">
                            <select id="unit-selector" class="bg-gray-200 dark:bg-gray-700 text-2xl text-gray-500 dark:text-gray-400 rounded-md p-1 pr-8 focus:outline-none appearance-none">
                                <option value="MnT">MnT</option>
                                <option value="t">t</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-gray-400">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>
                    <p id="cs-production-period-text" class="text-md text-gray-500 dark:text-gray-400 text-center">August 2025</p>
                </div>
                <div class="mt-4 flex-grow">
                    <div class="relative h-full">
                        <canvas id="prodChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Scrap Input Card -->
            <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col justify-between">
                <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                    <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">FY26 Data is Unaudited, Do not Share Externally</p>
                </div>
                <div class="absolute top-4 right-4 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                        Placeholder for Scrap Input information.
                        <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                    </div>
                </div>
                <div>
                     <div class="flex justify-center mb-2">
                        <svg class="w-8 h-8 text-orange-600 dark:text-orange-400" id="fi_4465639" enable-background="new 0 0 511.999 511.999" height="512" viewBox="0 0 511.999 511.999" width="512" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><g><path d="m145.564 305.606c4.301 7.275 12.23 11.794 20.696 11.794 4.279 0 8.504-1.16 12.223-3.357 11.395-6.749 15.177-21.514 8.433-32.912-5.374-9.082-8.215-19.656-8.215-30.581 0-11.943 3.509-23.529 9.828-33.067 3.238 2.921 7.509 4.717 12.203 4.717h35.592v66.941c0 13.248 10.778 24.026 24.026 24.026s24.026-10.778 24.026-24.026v-66.941h35.585c4.697 0 8.971-1.797 12.211-4.719 6.32 9.538 9.829 21.125 9.829 33.069 0 10.929-2.843 21.502-8.228 30.587-6.735 11.406-2.944 26.169 8.451 32.909 11.68 6.905 26.311 2.692 32.91-8.436 9.758-16.485 14.916-35.525 14.916-55.06 0-19.892-5.364-39.243-15.513-55.96-9.08-14.959-21.574-27.175-36.307-35.587v-2.583c0-10.068-8.196-18.26-18.27-18.26h-34.316v-125.66c0-6.893-5.607-12.5-12.5-12.5h-25.59c-6.893 0-12.5 5.607-12.5 12.5v33.286c0 4.143 3.357 7.5 7.5 7.5s7.5-3.357 7.5-7.5v-30.786h20.59v123.16h-20.59v-57.374c0-4.143-3.357-7.5-7.5-7.5s-7.5 3.357-7.5 7.5v57.374h-34.323c-10.069 0-18.261 8.191-18.261 18.26v2.582c-14.737 8.411-27.233 20.628-36.315 35.587-10.15 16.717-15.515 36.068-15.515 55.961 0 19.523 5.161 38.562 14.924 55.056zm114.785-7.439c-4.978 0-9.026-4.049-9.026-9.026v-97.977c0-4.978 4.049-9.026 9.026-9.026 4.978 0 9.026 4.049 9.026 9.026v97.977c0 4.978-4.048 9.026-9.026 9.026zm114.701-47.618c0 16.849-4.435 33.246-12.821 47.414-2.601 4.387-8.135 5.673-12.37 3.171-4.28-2.532-5.702-8.082-3.176-12.36 6.75-11.389 10.317-24.606 10.317-38.225 0-18.525-6.809-36.437-18.77-49.663v-24.059c22.695 16.442 36.82 44.125 36.82 73.722zm-177.58-94.129c0-1.798 1.463-3.26 3.261-3.26h119.229c1.804 0 3.271 1.462 3.271 3.26v47.51c0 1.804-1.467 3.27-3.271 3.27h-35.585v-16.036c0-13.248-10.778-24.026-24.026-24.026s-24.026 10.778-24.026 24.026v16.036h-35.592c-1.798 0-3.261-1.467-3.261-3.27zm-15 20.405v24.061c-11.96 13.226-18.77 31.138-18.77 49.663 0 13.61 3.563 26.827 10.305 38.22 2.535 4.283 1.114 9.832-3.16 12.363-1.403.829-2.988 1.268-4.585 1.268-3.187 0-6.17-1.696-7.786-4.431-8.396-14.186-12.834-30.583-12.834-47.42 0-29.599 14.13-57.284 36.83-73.724z"></path><path d="m465.491 496.999h-19.133v-36.231c0-12.608-10.258-22.866-22.867-22.866h-5.738c-3.034 0-5.829-1.775-7.12-4.521l-3.527-7.507c-1.763-3.749-6.232-5.361-9.978-3.599-3.749 1.762-5.36 6.228-3.599 9.978l3.527 7.507c3.752 7.984 11.876 13.143 20.696 13.143h5.738c4.338 0 7.867 3.528 7.867 7.866v36.231h-343.481l3.105-17.878c.336-1.935 1.859-3.458 3.795-3.791l15.132-2.608c5.154-.883 9.826-3.852 12.827-8.158l19.824-28.582c2.279-3.276 6.015-5.232 9.992-5.232h15.57l-3.659 6.337c-2.961 5.129-2.961 11.501 0 16.63l13.966 24.19c2.962 5.128 8.479 8.313 14.401 8.313h27.932c5.922 0 11.439-3.186 14.401-8.314l13.967-24.191c2.958-5.128 2.958-11.498-.001-16.628l-13.966-24.188c-2.004-3.472-5.182-6.049-8.862-7.355l4.588-24.111c1.097-5.755 6.144-9.933 12.003-9.933h35.36c3.113 0 6.082 1.172 8.356 3.297l10.779 10.084-11.089 11.089c-4.937 4.938-4.937 12.971 0 17.911l9.371 9.371-20.958 20.957c-1.962 1.964-3.239 4.561-3.599 7.311l-2.664 20.393c-.514 3.931.799 7.793 3.603 10.596 2.403 2.404 5.586 3.712 8.923 3.712.554 0 1.113-.036 1.673-.109l20.391-2.664c2.751-.358 5.349-1.637 7.316-3.603l20.954-20.955 9.372 9.372c2.47 2.469 5.713 3.703 8.955 3.703 3.243 0 6.486-1.234 8.956-3.703l18.442-18.442c4.938-4.938 4.938-12.973 0-17.911l-33.255-33.255 23.602-6.61c3.716-1.037 7.603.74 9.245 4.239l2 4.25c1.278 2.716 3.976 4.309 6.791 4.309 1.069 0 2.156-.23 3.188-.716 3.748-1.764 5.356-6.231 3.593-9.979l-1.996-4.242c-4.762-10.15-16.061-15.326-26.862-12.306l-31.729 8.887-8.958-8.958c-2.393-2.392-5.572-3.709-8.955-3.709-1.769 0-3.479.368-5.053 1.054l-11.792-11.032c-5.065-4.733-11.672-7.34-18.601-7.34h-35.36c-13.052 0-24.297 9.306-26.738 22.128l-4.94 25.955h-18.383c-5.922 0-11.44 3.187-14.401 8.315l-1.646 2.852h-14.63l-31.062-53.784c-3.569-6.195-11.524-8.335-17.748-4.761l-17.923 10.347c-6.185 3.587-8.312 11.542-4.742 17.738l31.25 54.12-11.508 16.592c-.711 1.021-1.82 1.727-3.052 1.938l-15.135 2.609c-8.17 1.403-14.612 7.837-16.03 16.008l-3.55 20.443h-17.445c-4.143 0-7.5 3.357-7.5 7.5s3.357 7.5 7.5 7.5h410.284c4.143 0 7.5-3.357 7.5-7.5 0-4.146-3.357-7.503-7.5-7.503zm-165.183-28.322-16.594 2.168 2.168-16.594 20.393-20.393 14.425 14.425zm49.326-12.674c-7.134-7.134-51.078-51.079-51.078-51.079l15.14-15.139 51.078 51.078zm-156.805-36.421h27.932c.58 0 1.121.312 1.411.815l13.965 24.186c.29.504.29 1.13.001 1.632l-13.966 24.188c-.29.503-.831.815-1.411.815h-27.932c-.58 0-1.121-.312-1.411-.814l-13.966-24.189c-.29-.503-.29-1.127 0-1.63l13.966-24.188c.291-.502.831-.815 1.411-.815zm-73.729-48.383 26.291 45.525c-5.452 1.494-10.355 4.664-13.969 9.134l-26.752-46.329z"></path><path d="m401.041 111.715c.1 0 .2-.002.301-.006 4.139-.163 7.361-3.651 7.198-7.79l-.98-24.842c15.747 16.699 28.422 35.751 37.735 56.805 11.399 25.769 17.179 53.247 17.179 81.669 0 37.765-10.475 74.581-30.29 106.468-2.187 3.519-1.106 8.143 2.411 10.329 3.506 2.178 8.134 1.12 10.329-2.411 21.294-34.266 32.55-73.82 32.55-114.386 0-30.525-6.211-60.045-18.461-87.737-9.712-21.955-22.817-41.886-39.044-59.439l21.277.839c4.124.147 7.627-3.06 7.79-7.198s-3.06-7.627-7.198-7.79l-30.991-1.223c-3.972-.147-7.848 1.049-11.038 3.319-.397.247-.767.542-1.128.861-.384.338-.779.665-1.143 1.029-3.505 3.506-5.403 8.357-5.207 13.31l1.223 30.989c.157 4.038 3.481 7.204 7.487 7.204z"></path><path d="m92.034 319.599 7.366-30.126c.984-4.023-1.48-8.083-5.504-9.066-4.024-.985-8.083 1.48-9.066 5.504l-5.532 22.623c-8.829-17.523-15.036-36.25-18.493-55.845-12.879-73.051 15.214-147.155 73.315-193.396 3.241-2.579 3.777-7.298 1.198-10.538-2.578-3.242-7.297-3.778-10.538-1.198-62.407 49.666-92.581 129.267-78.746 207.736 3.724 21.112 10.422 41.291 19.958 60.172l-21.616-7.132c-3.933-1.299-8.174.839-9.472 4.772-1.298 3.934.839 8.174 4.772 9.472l29.451 9.717c9.866 3.259 20.439-2.603 22.907-12.695z"></path></g></svg>
                    </div>
                    <h2 class="text-xl font-semibold mb-2 text-orange-600 dark:text-orange-400 text-center">Scrap Input</h2>
                    <p class="text-5xl font-bold mb-1 text-center">
                        <span id="scrap-input-value">5.8</span> 
                        <span class="text-2xl text-gray-500 dark:text-gray-400">%</span>
                    </p>
                    <p class="text-md text-gray-500 dark:text-gray-400 text-center">vs Target: 7.1%</p>
                </div>
                <div class="mt-4 flex-grow">
                    <canvas id="scrapChart"></canvas>
                </div>
            </div>
        </main>

        <!-- Detailed Charts Section -->
        <section class="mb-6">
            <!-- New Energy Card -->
            <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg">
                <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                    <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">FY26 Data is Unaudited, Do not Share Externally</p>
                </div>

                <div class="absolute top-4 right-4 flex flex-col items-end gap-2 z-10">
                    <div class="group relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                        <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            Placeholder for Energy information.
                            <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                        </div>
                    </div>
                     <div id="re-toggle-container" class="inline-flex p-1 bg-gray-200 dark:bg-gray-700 rounded-md">
                        <button data-type="grid" class="re-toggle-btn active bg-white dark:bg-gray-600">Grid</button>
                        <button data-type="total" class="re-toggle-btn">Total</button>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="flex justify-center mb-2">
                        <svg class="w-8 h-8 text-green-600 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-semibold mb-2 text-green-600 dark:text-green-400 text-center">Energy Intensity</h2>
                    <p class="text-5xl font-bold mb-1 text-center">
                        <span id="energy-intensity-value">1.02</span> 
                        <span class="text-2xl text-gray-500 dark:text-gray-400">MWh/tcs</span>
                    </p>
                    <p id="energy-intensity-subtitle" class="text-md text-gray-500 dark:text-gray-400 text-center">August 2025</p>
                </div>

                <div id="energy-chart-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Chart 1: Consumption -->
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
                        <div class="flex justify-between items-baseline mb-2">
                            <h3 class="text-lg font-semibold">Consumption</h3>
                            <span class="text-sm text-gray-500 dark:text-gray-400">MWh</span>
                        </div>
                         <div class="relative h-64">
                            <canvas id="energyBreakdownChart"></canvas>
                        </div>
                    </div>
                    <!-- Chart 2: Renewable % -->
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
                        <div class="flex justify-between items-baseline mb-2">
                            <h3 class="text-lg font-semibold">Renewable Energy Share</h3>
                             <span class="text-sm text-gray-500 dark:text-gray-400">%</span>
                        </div>
                         <div class="relative h-64">
                            <canvas id="energyRenewableChart"></canvas>
                        </div>
                    </div>
                    <!-- Chart 3: Composition -->
                    <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
                         <div class="flex justify-between items-baseline mb-2">
                            <h3 id="composition-title" class="text-lg font-semibold">Composition</h3>
                            <span class="text-sm text-gray-500 dark:text-gray-400">%</span>
                        </div>
                        <div class="relative h-64">
                            <canvas id="energyCompositionChart"></canvas>
                        </div>
                    </div>
                </div>
                <p id="energy-chart-placeholder" class="text-center text-gray-500 dark:text-gray-400 mt-12 hidden">Data not available for this period.</p>
            </div>
        </section>

        <!-- New Placeholder Cards Section -->
        <section class="mb-12">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Water Intensity Card -->
                <div class="lg:w-2/3 relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col justify-between">
                    <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                        <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">FY26 Data is Unaudited, Do not Share Externally</p>
                    </div>
                    <div class="absolute top-4 right-4 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 divide-x divide-gray-200 dark:divide-gray-700 mb-6">
                        <div class="text-center px-4 py-2">
                            <div class="flex justify-center mb-1">
                                <svg class="w-8 h-8 text-blue-600 dark:text-blue-400" height="512" viewBox="0 0 60 60" width="512" xmlns="http://www.w3.org/2000/svg" id="fi_3251386"><g id="Page-1" fill="none" fill-rule="evenodd"><g id="028---Water-Management" fill="currentColor" fill-rule="nonzero"><path id="Shape" d="m30 9c-11.5979797 0-21 9.4020203-21 21s9.4020203 21 21 21 21-9.4020203 21-21c-.0132259-11.592497-9.407503-20.98677409-21-21zm-16.443 30.478c.3950479-.1843215.7766545-.3961766 1.142-.634.7607673-.5695566 1.6909257-.8668129 2.641-.844.9491965-.0230561 1.8783746.275042 2.637.846 1.0769931.7751256 2.3763293 1.1800497 3.703 1.154 1.3233318.0253963 2.6191912-.379187 3.693-1.153 1.5728319-1.1274197 3.6891681-1.1274197 5.262 0 2.2259503 1.5411258 5.1740497 1.5411258 7.4 0 1.5737028-1.1274535 3.690159-1.1294631 5.266-.005.365565.2389049.7478909.4511225 1.144.635-.4009301.6904846-.8448027 1.3551245-1.329 1.99-.7740789-.3237623-1.6070898-.482804-2.446-.467-1.325928-.0251784-2.6242432.3804574-3.7 1.156-1.5728319 1.1274197-3.6891681 1.1274197-5.262 0-2.2259503-1.5411258-5.1740497-1.5411258-7.4 0-1.5730292 1.1268057-3.6889708 1.1268057-5.262 0-1.0775716-.7764571-2.3780829-1.1821212-3.706-1.156-.8415209-.01604-1.6771912.1429894-2.454.467-.48419-.6345328-.9280632-1.2988395-1.329-1.989zm16.443 9.522c-5.1833109-.0011333-10.1394555-2.1275188-13.712-5.883.3449965-.0793497.6979995-.1186095 1.052-.117.9491965-.0230561 1.8783746.275042 2.637.846 1.0769931.7751256 2.3763293 1.1800497 3.703 1.154 1.3233318.0253963 2.6191912-.379187 3.693-1.153 1.5728319-1.1274197 3.6891681-1.1274197 5.262 0 2.2259503 1.5411258 5.1740497 1.5411258 7.4 0 .757881-.571026 1.6863435-.869473 2.635-.847.3512715-.0020778.701603.0365124 1.044.115-3.5726126 3.7568199-8.5296721 5.8840107-13.714 5.885zm17.358-11.308c-.345954-.1524567-.6784612-.3337634-.994-.542-2.228274-1.5358687-5.1742196-1.5334801-7.4.006-1.5728319 1.1274197-3.6891681 1.1274197-5.262 0-2.2259503-1.5411258-5.1740497-1.5411258-7.4 0-1.5730292 1.1268057-3.6889708 1.1268057-5.262 0-1.0759201-.775216-2.3741237-1.1808169-3.7-1.156-1.3251583-.0251899-2.6229765.3785368-3.7 1.151-.3152124.2079121-.6473881.388886-.993.541-3.54713563-7.968763-1.2127892-17.3291261 5.6608429-22.6990923 6.8736322-5.36996613 16.520682-5.36996613 23.3943142 0 6.8736321 5.3699662 9.2079785 14.7303293 5.6608429 22.6990923z"></path><path id="Shape" d="m58.2 25.02-2.8-.559c-.6512313-3.0252157-1.8444503-5.9076425-3.522-8.508l1.579-2.369c.1092599-.1645007.1676876-.3575206.168-.555 0-.3-.116-1.945-2.414-4.242s-3.937-2.414-4.242-2.414c-.1975323-.00004431-.3906531.05841388-.555.168l-2.367 1.579c-2.6003597-1.67642326-5.4823715-2.86893315-8.507-3.52l-.56-2.8c-.0385839-.19353984-.1335711-.37133627-.273-.511-.216-.212-1.457-1.289-4.707-1.289s-4.491 1.077-4.707 1.293c-.1394289.13966373-.2344161.31746016-.273.511l-.56 2.796c-3.0246285.65106685-5.9066403 1.84357674-8.507 3.52l-2.369-1.579c-.1643469-.10958612-.3574677-.16804431-.555-.168-.3 0-1.944.116-4.242 2.414s-2.414 3.937-2.414 4.242c.00031242.1974794.05874008.3904993.168.555l1.579 2.369c-1.67684682 2.6005-2.86938496 5.4829189-3.52 8.508l-2.8.559c-.19372441.0380671-.37166323.1331304-.511.273-.212.216-1.289 1.457-1.289 4.707s1.077 4.491 1.293 4.707c.13933677.1398696.31727559.2349329.511.273l2.794.559c.65123131 3.0252157 1.84445027 5.9076425 3.522 8.508l-1.579 2.369c-.10925992.1645007-.16768758.3575206-.168.555 0 .305.116 1.945 2.414 4.242s3.937 2.414 4.242 2.414c.1975323.0000443.3906531-.0584139.555-.168l2.369-1.579c2.6003597 1.6764233 5.4823715 2.8689332 8.507 3.52l.56 2.794c.0385839.1935398.1335711.3713363.273.511.216.218 1.457 1.295 4.707 1.295s4.491-1.077 4.707-1.293c.1394289-.1396637.2344161-.3174602.273-.511l.56-2.794c3.024763-.6516832 5.9067827-1.8448739 8.507-3.522l2.369 1.579c.1643469.1095861.3574677.1680443.555.168.305 0 1.944-.116 4.242-2.414s2.414-3.937 2.414-4.242c-.0003124-.1974794-.0587401-.3904993-.168-.555l-1.579-2.369c1.6768468-2.6005 2.869385-5.4829189 3.52-8.508l2.8-.559c.1937244-.0380671.3716632-.1331304.511-.273.212-.216 1.289-1.457 1.289-4.707s-1.077-4.491-1.293-4.707c-.138254-.1391758-.3147043-.2341875-.507-.273zm-.791 8.08-3.051.61c-.3992049.0799834-.7100632.3940056-.786.794-.6062456 3.219104-1.8721241 6.2779131-3.718 8.984-.2295936.3366384-.2319672.7789167-.006 1.118l1.723 2.586c-.3679709 1.0011851-.9761011 1.8967264-1.771 2.608-.7099529.7939335-1.6022267 1.4034252-2.6 1.776l-2.6-1.728c-.3388799-.2262682-.7811575-.2242902-1.118.005-2.7052697 1.8462317-5.7634334 3.1124654-8.982 3.719-.3999944.0759368-.7140166.3867951-.794.786l-.61 3.051c-.9680858.4473908-2.031186.6503276-3.096.591-1.0655752.0591087-2.1295262-.1420124-3.1-.586l-.611-3.056c-.0799834-.3992049-.3940056-.7100632-.794-.786-3.2189151-.6064028-6.2774317-1.8726417-8.983-3.719-.3368425-.2292902-.7791201-.2312682-1.118-.005l-2.584 1.724c-1.0020097-.3679678-1.8982758-.9764672-2.61-1.772-.79378158-.7098791-1.40296203-1.6021998-1.775-2.6l1.726-2.59c.2259672-.3390833.2235936-.7813616-.006-1.118-1.84653553-2.7085577-3.11211268-5.7701853-3.717-8.992-.0759368-.3999944-.38679511-.7140166-.786-.794l-3.051-.606c-.4482328-.9692338-.65119426-2.0338371-.591-3.1-.05910869-1.0655752.14201236-2.1295262.586-3.1l3.056-.61c.39920489-.0799834.7100632-.3940056.786-.794.60624556-3.219104 1.87212407-6.2779131 3.718-8.984.2295936-.3366384.2319672-.7789167.006-1.118l-1.723-2.584c.36768203-1.001906.9758315-1.8981624 1.771-2.61.7099529-.79393349 1.6022267-1.40342516 2.6-1.776l2.59 1.727c.337862.2277765.780138.2277765 1.118 0 2.7079277-1.84891309 5.7696417-3.1165689 8.992-3.723.3999944-.0759368.7140166-.38679511.794-.786l.61-3.051c.9680858-.44739082 2.031186-.65032759 3.096-.591 1.0655752-.05910869 2.1295262.14201236 3.1.586l.611 3.056c.0799834.39920489.3940056.7100632.794.786 3.2189151.60640285 6.2774317 1.87264167 8.983 3.719.337862.2277765.780138.2277765 1.118 0l2.584-1.719c1.0020097.36796783 1.8982758.97646724 2.61 1.772.7937816.7098791 1.402962 1.6021998 1.775 2.6l-1.727 2.6c-.2259672.3390833-.2235936.7813616.006 1.118 1.8456228 2.7054896 3.111491 5.7635929 3.718 8.982.0759368.3999944.3867951.7140166.786.794l3.051.61c.4475866.9680229.6505328 2.0311724.591 3.096.0601943 1.0661629-.1427672 2.1307662-.591 3.1z"></path><path id="Shape" d="m31.22 13.464c-.6975671-.6136987-1.7424329-.6136987-2.44 0-2.039 1.8-6.78 6.586-6.78 12.2-.0010264 2.2682209.9006465 4.4436057 2.506 6.046 1.4556467 1.4610179 3.4316101 2.2846357 5.494 2.29h.1c4.4625244-.1669778 7.9727626-3.8709456 7.9-8.336 0-5.611-4.741-10.401-6.78-12.2zm-1.146 18.536c-1.562662.0167383-3.065123-.6018584-4.163-1.714-1.225867-1.2259317-1.9134577-2.8893183-1.911-4.623 0-4.82 4.46-9.229 6-10.607 1.54 1.378 6 5.79 6 10.608.0772523 3.3724419-2.5559302 6.1878054-5.926 6.336z"></path><path id="Shape" d="m29.964 28c-1.0941805-.0109946-1.9728797-.9058003-1.964-2 0-.5522847-.4477153-1-1-1s-1 .4477153-1 1c-.0077545 2.1983031 1.7657166 3.9878805 3.964 4h.036c.2632485-.0007678.5152126-.1069856.6995644-.2949079.1843517-.1879222.2857172-.4418773.2814356-.7050921-.0076707-.5557121-.4612375-1.0016972-1.017-1z"></path></g></g></svg>
                            </div>
                            <h3 class="text-xl font-semibold text-blue-600 dark:text-blue-400 mb-2">Water Intensity</h3>
                            <p class="text-5xl font-bold mb-1">
                                <span id="water-intensity-value">0.0</span> 
                                <span class="text-2xl text-gray-500 dark:text-gray-400">m³/tcs</span>
                            </p>
                            <p id="water-intensity-subtitle" class="text-md text-gray-500 dark:text-gray-400">August 2025</p>
                        </div>
                        <div class="text-center px-4 py-2">
                            <div class="flex justify-center mb-1">
                                <svg id="fi_16998783" class="w-8 h-8 text-blue-600 dark:text-blue-400" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1" fill="currentColor"><path d="m45 39c-.552 0-1 .448-1 1v1c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552-.448-1-1-1z"></path><path d="m15.036 33.5c-.66-.023-1.289-.225-1.728-.552-1.221-.911-3.1-1.191-4.61-.712-.527.167-.818.729-.651 1.255.167.527.731.821 1.255.651.899-.283 2.104-.117 2.81.408.767.573 1.78.91 2.853.948h.036c.536 0 .979-.424.999-.964.02-.552-.412-1.015-.964-1.035z"></path><path d="m31.299 32.235c-.395-.123-.812-.199-1.24-.224-.55-.038-1.024.387-1.057.939-.033.551.388 1.024.939 1.057.262.016.524.063.76.137.1.031.2.046.299.046.425 0 .82-.274.954-.702.165-.527-.129-1.088-.656-1.253z"></path><path d="m25.739 33.385c-.936.253-2.042.062-2.7-.428-.172-.133-.37-.253-.568-.359-.488-.262-1.094-.076-1.353.411-.26.487-.077 1.093.411 1.353.102.054.204.114.303.189.82.612 1.895.949 3.028.949.477 0 .948-.062 1.401-.185.533-.144.848-.693.704-1.227-.145-.533-.694-.849-1.227-.704z"></path><path d="m44 34h-1.5v-1h.5c.552 0 1-.448 1-1s-.448-1-1-1h-3c-.552 0-1 .448-1 1s.448 1 1 1h.5v1h-2.5v-7c0-.552-.448-1-1-1s-1 .448-1 1v2.192c-.998.486-2.393.405-3.26-.242-1.7-1.27-4.35-1.27-6.05 0-.99.74-2.67.74-3.66 0-1.7-1.27-4.36-1.27-6.06 0-.99.74-2.67.74-3.66 0-1.7-1.27-4.35-1.27-6.05 0-.867.648-2.262.728-3.26.242v-2.192c0-.552-.448-1-1-1s-1 .448-1 1v14c0 2.757 2.243 5 5 5h26c2.757 0 5-2.243 5-5v-5h6v.969c0 .552.448 1 1 1s1-.448 1-1v-.969c0-1.103-.897-2-2-2zm-11 10h-26c-1.654 0-3-1.346-3-3v-9.695c.463.126.945.195 1.43.195 1.09 0 2.18-.32 3.02-.95 1-.74 2.67-.74 3.67 0 1.69 1.27 4.35 1.27 6.05 0 .99-.74 2.67-.74 3.66 0 1.7 1.27 4.36 1.27 6.05 0 1-.74 2.67-.74 3.67 0 1.219.919 2.944 1.158 4.45.747v9.703c0 1.654-1.346 3-3 3z"></path><path d="m6.757 16.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.676-.86-1.213-.728z"></path><path d="m15.591 16.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.676-.86-1.213-.728z"></path><path d="m24.424 16.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.678-.86-1.213-.728z"></path><path d="m33.257 16.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.677-.86-1.213-.728z"></path><path d="m11.591 21.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.678-.862-1.213-.728z"></path><path d="m20.424 21.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.677-.862-1.213-.728z"></path><path d="m29.257 21.03c-.536.134-.861.677-.728 1.213l.5 2c.114.454.521.757.969.757.081 0 .162-.009.244-.03.536-.134.861-.677.728-1.213l-.5-2c-.134-.536-.676-.862-1.213-.728z"></path><path d="m5.132 14h29.735c.625 0 1.202-.284 1.585-.778.382-.493.512-1.121.357-1.723-.738-2.859-3.511-4.792-6.464-4.462-1.144-2.447-3.595-4.037-6.346-4.037-1.172 0-2.295.283-3.295.824-1.277-1.167-2.95-1.824-4.705-1.824-3.114 0-5.841 2.094-6.707 5.007-.097-.005-.195-.007-.293-.007-2.737 0-5.126 1.85-5.81 4.499-.155.602-.025 1.23.357 1.723.383.495.961.778 1.585.778zm3.868-5c.291 0 .567.031.847.095.273.063.559.008.789-.15s.384-.404.424-.681c.354-2.431 2.478-4.264 4.94-4.264 1.462 0 2.843.637 3.789 1.749.338.396.923.467 1.347.163.826-.596 1.816-.911 2.865-.911 2.179 0 4.095 1.397 4.768 3.478.164.507.699.797 1.21.658.336-.09.68-.136 1.021-.136 1.825 0 3.418 1.233 3.87 3h-29.744c.456-1.767 2.048-3 3.874-3z"></path></svg>
                            </div>
                            <h3 class="text-xl font-semibold text-blue-600 dark:text-blue-400 mb-2">Rainwater Harvested</h3>
                            <p id="rainwater-harvested-value" class="text-5xl font-bold mb-1">0</p>
                             <p id="rainwater-harvested-subtitle" class="text-md text-gray-500 dark:text-gray-400">m³ (YTD)</p>
                        </div>
                    </div>

                    <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Chart Column 1: Specific Consumption -->
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
                            <h3 class="text-md font-semibold text-center mb-2">Specific Consumption Trend</h3>
                            <div class="relative h-48">
                                <canvas id="waterIntensityChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Chart Column 2: Water Breakdown -->
                        <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg">
                            <h3 class="text-md font-semibold text-center mb-2">Withdrawal vs. Recycled</h3>
                            <div class="relative h-48">
                                <canvas id="waterBreakdownChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>


                 <!-- Tree Plantation Card -->
                 <div class="lg:w-1/3 relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col justify-between">
                    <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                        <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">FY26 Data is Unaudited, Do not Share Externally</p>
                    </div>
                    <div class="absolute top-4 right-4 group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <div class="flex justify-center mb-2">
                           <svg class="w-8 h-8 text-green-600 dark:text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21.75c4.832 0 8.75-3.918 8.75-8.75S16.832 4.25 12 4.25 3.25 8.168 3.25 13 7.168 21.75 12 21.75z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 8.25h6m-3 7.5v-7.5" />
                            </svg>
                        </div>
                        <h2 class="text-xl font-semibold mb-2 text-green-600 dark:text-green-400 text-center">Tree Plantation</h2>
                    </div>
                    <div class="flex-grow flex items-center justify-center">
                        <p class="text-gray-500 dark:text-gray-400">Data for this section is not yet available.</p>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        let co2LineChartInstance = null;
        let prodChartInstance = null;
        let scrapChartInstance = null;
        let energyChartInstances = {};
        let waterIntensityChartInstance = null;
        let waterBreakdownChartInstance = null;
        let lastQuarterUsed = null;
        let currentDataView = 'monthly';
        let selectedMonthYM = '2025-08'; 
        let renewableShareType = 'grid'; // 'grid' or 'total'

        // --- THEME TOGGLE LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        function setAutoTheme() {
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000;
            const istTime = new Date(now.getTime() + istOffset);
            const istHour = istTime.getUTCHours();
            const isNight = istHour >= 17 || istHour < 6;

            document.documentElement.classList.remove('dark', 'light');
            
            if (isNight) {
                document.documentElement.classList.add('dark');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.add('light');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
        }
        
        setAutoTheme(); // Run auto-theme on initial load

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            lightIcon.classList.toggle('hidden');
            darkIcon.classList.toggle('hidden');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateDashboard(currentDataView); // Re-render charts with updated colors
        });


        // --- DATA STORE ---
        const fullDataSeries = [
             { ym: '2024-01', productionMTD: 668528.00, totalAbsEmissionMTD: 1482810.00, internalScrap: 20404.00, externalScrap: 6177.00 },
            { ym: '2024-02', productionMTD: 637899.00, totalAbsEmissionMTD: 1394002.00, internalScrap: 21933.00, externalScrap: 3574.00 },
            { ym: '2024-03', productionMTD: 678052.00, totalAbsEmissionMTD: 1440466.00, internalScrap: 22851.00, externalScrap: 6425.00 },
            { ym: '2024-04', productionMTD: 653105.00, totalAbsEmissionMTD: 1410577.00, internalScrap: 22398.00, externalScrap: 2157.00, totalElectricity: 643849.00, gridElectricity: 413023.00, renewableElectricity: 113201.00, specificWaterConsumption: 3.22, waterWithdrawal: 3920265, waterRecycled: 489996, rainwaterHarvested: 0 },
            { ym: '2024-05', productionMTD: 628778.00, totalAbsEmissionMTD: 1377834.00, internalScrap: 11571.00, externalScrap: 945.00, totalElectricity: 637645.00, gridElectricity: 447012.00, renewableElectricity: 121180.00, specificWaterConsumption: 3.34, waterWithdrawal: 3952302, waterRecycled: 510166, rainwaterHarvested: 0 },
            { ym: '2024-06', productionMTD: 583100.00, totalAbsEmissionMTD: 1310694.00, internalScrap: 16661.00, externalScrap: 1238.00, totalElectricity: 582882.00, gridElectricity: 406391.00, renewableElectricity: 142366.00, specificWaterConsumption: 3.2, waterWithdrawal: 3711290, waterRecycled: 489648, rainwaterHarvested: 0 },
            { ym: '2024-07', productionMTD: 588554.00, totalAbsEmissionMTD: 1337874.00, internalScrap: 16830.00, externalScrap: 1109.00, totalElectricity: 609010.00, gridElectricity: 408262.00, renewableElectricity: 142915.00, specificWaterConsumption: 3.2, waterWithdrawal: 3851194, waterRecycled: 515539, rainwaterHarvested: 181585 },
            { ym: '2024-08', productionMTD: 631284.00, totalAbsEmissionMTD: 1368522.00, internalScrap: 34898.00, externalScrap: 4084.00, totalElectricity: 641066.00, gridElectricity: 460137.00, renewableElectricity: 214638.00, specificWaterConsumption: 3.24, waterWithdrawal: 3756240, waterRecycled: 531264, rainwaterHarvested: 128608 },
            { ym: '2024-09', productionMTD: 523245.00, totalAbsEmissionMTD: 1163087.00, internalScrap: 30312.00, externalScrap: 3732.00, totalElectricity: 558754.00, gridElectricity: 378786.00, renewableElectricity: 173051.00, specificWaterConsumption: 3.43, waterWithdrawal: 2990164, waterRecycled: 628463, rainwaterHarvested: 510 },
            { ym: '2024-10', productionMTD: 661370.00, totalAbsEmissionMTD: 1356894.00, internalScrap: 28390.00, externalScrap: 5855.00, totalElectricity: 649596.00, gridElectricity: 488921.00, renewableElectricity: 206368.00, specificWaterConsumption: 3.07, waterWithdrawal: 3937696, waterRecycled: 535146, rainwaterHarvested: 10075 },
            { ym: '2024-11', productionMTD: 654595.00, totalAbsEmissionMTD: 1331781.00, internalScrap: 21043.00, externalScrap: 6048.00, totalElectricity: 625225.00, gridElectricity: 468289.00, renewableElectricity: 162268.00, specificWaterConsumption: 3.27, waterWithdrawal: 4079991, waterRecycled: 529051, rainwaterHarvested: 0 },
            { ym: '2024-12', productionMTD: 633637.00, totalAbsEmissionMTD: 1363499.00, internalScrap: 34691.00, externalScrap: 12727.00, totalElectricity: 622837.00, gridElectricity: 437138.00, renewableElectricity: 138620.00, specificWaterConsumption: 3.27, waterWithdrawal: 3964667, waterRecycled: 469834, rainwaterHarvested: 0 },
            { ym: '2025-01', productionMTD: 530428.00, totalAbsEmissionMTD: 1128120.00, internalScrap: 41776.00, externalScrap: 20138.00, totalElectricity: 572769.00, gridElectricity: 437013.00, renewableElectricity: 126796.00, specificWaterConsumption: 3.43, waterWithdrawal: 3603183, waterRecycled: 493357, rainwaterHarvested: 0 },
            { ym: '2025-02', productionMTD: 549687.00, totalAbsEmissionMTD: 1154141.00, internalScrap: 22604.00, externalScrap: 18469.00, totalElectricity: 543798.00, gridElectricity: 442011.00, renewableElectricity: 172096.00, specificWaterConsumption: 3.24, waterWithdrawal: 3187649, waterRecycled: 456844, rainwaterHarvested: 0 },
            { ym: '2025-03', productionMTD: 603752.00, totalAbsEmissionMTD: 1332623.00, internalScrap: 14387.00, externalScrap: 9522.00, totalElectricity: 600975.00, gridElectricity: 516231.00, renewableElectricity: 199677.00, specificWaterConsumption: 3.16, waterWithdrawal: 3487211, waterRecycled: 521370, rainwaterHarvested: 0 },
            { ym: '2025-04', productionMTD: 596980.00, totalAbsEmissionMTD: 1245932.00, internalScrap: 26089.00, externalScrap: 6623.00, totalElectricity: 620818.00, gridElectricity: 454545.00, renewableElectricity: 170536.00, specificWaterConsumption: 3.25, waterWithdrawal: 3659729, waterRecycled: 509231, rainwaterHarvested: 0 },
            { ym: '2025-05', productionMTD: 587534.07, totalAbsEmissionMTD: 1265043.00, internalScrap: 33322.00, externalScrap: 8243.00, totalElectricity: 638354.00, gridElectricity: 449690.00, renewableElectricity: 182706.00, specificWaterConsumption: 3.27, waterWithdrawal: 3500672, waterRecycled: 512411, rainwaterHarvested: 0 },
            { ym: '2025-06', productionMTD: 644157.05, totalAbsEmissionMTD: 1336695.00, internalScrap: 29070.00, externalScrap: 7895.00, totalElectricity: 646968.00, gridElectricity: 463709.00, renewableElectricity: 228708.00, specificWaterConsumption: 2.91, waterWithdrawal: 3644037, waterRecycled: 508834, rainwaterHarvested: 39390 },
            { ym: '2025-07', productionMTD: 637576.00, totalAbsEmissionMTD: 1356904.00, internalScrap: 16064.00, externalScrap: 19383.00, totalElectricity: 651959.00, gridElectricity: 491532.00, renewableElectricity: 245604.00, specificWaterConsumption: 2.99, waterWithdrawal: 3465099, waterRecycled: 508924, rainwaterHarvested: 125240 },
            { ym: '2025-08', productionMTD: 619305.00, totalAbsEmissionMTD: 1320708.00, internalScrap: 27958.00, externalScrap: 7978.00, totalElectricity: 630488.00, gridElectricity: 508484.00, renewableElectricity: 237647.00, specificWaterConsumption: 2.81, waterWithdrawal: 3367815, waterRecycled: 452158, rainwaterHarvested: 33371 },
            { ym: '2025-09', specificWaterConsumption: 2.81, waterWithdrawal: 2987116, waterRecycled: 453614, rainwaterHarvested: 54541 },
        ];
        selectedMonthYM = fullDataSeries[fullDataSeries.length - 2].ym; // Set to Aug 25 initially

        // Pre-calculated/static data for different views
        const dashboardData = {
            monthly: {
                overviewText: 'August 2025 Overview',
                production: { value: 0.62, valueInTonnes: 619305.00, periodLabel: 'August 2025' }
            },
            quarterly: {
                overviewText: 'Q2 FY26 Overview',
                co2: { labels: [], emissions: [], target: [], average: 0 },
                production: { value: 1.90, valueInTonnes: 1901038.05, periodLabel: 'Q2 FY26' }
            },
            ytd: {
                overviewText: 'Year-to-Date Overview',
                production: { value: 3.09, valueInTonnes: 3087852.12, periodLabel: 'April 2025 to latest month' }
            }
        };

        // --- DATA HELPERS & CALCULATORS ---
        const toMonthLabel = (ym) => new Date(ym + '-02').toLocaleString('en-US', { month: 'long', year: 'numeric' });
        const AVAILABLE_MONTHS = new Set(fullDataSeries.map(d => d.ym));
        
        function ymToParts(ym){ const [y,m] = ym.split('-').map(Number); return {y, m}; }
        function toYM(y,m){ return `${y}-${String(m).padStart(2,'0')}`; }
        function getFY(ym) {
            if (!ym) return null;
            const [year, month] = ym.split('-').map(Number);
            return month >= 4 ? `FY${year + 1}` : `FY${year}`;
        }
        function quarterFromMonth(m){ if(m>=4&&m<=6) return 1; if(m>=7&&m<=9) return 2; if(m>=10&&m<=12) return 3; return 4; }
        
        function quarterRangeForYM(ym){
            const {y,m} = ymToParts(ym); const q = quarterFromMonth(m);
            const fy = getFY(ym);
            if(q===1){ return { start: toYM(y,4), end: toYM(y,6), q, fy }; }
            if(q===2){ return { start: toYM(y,7), end: toYM(y,9), q, fy }; }
            if(q===3){ return { start: toYM(y,10), end: toYM(y,12), q, fy }; }
            return { start: toYM(y,1), end: toYM(y,3), q: 4, fy };
        }
        
        function previousQuarterRangeForYM(ym){
            let {y,m} = ymToParts(ym);
            m -= 3;
            if (m < 1) { m += 12; y -= 1; }
            return quarterRangeForYM(toYM(y, m));
        }

        function monthsBetweenInclusive(startYM,endYM){
            const out=[]; let {y:ys,m:ms}=ymToParts(startYM); const {y:ye,m:me}=ymToParts(endYM);
            while(ys<ye || (ys===ye && ms<=me)){ out.push(toYM(ys,ms)); ms++; if(ms>12){ ms=1; ys++; } }
            return out;
        }
        function hasAllMonths(startYM,endYM){ return monthsBetweenInclusive(startYM,endYM).every(ym => AVAILABLE_MONTHS.has(ym)); }
        function rangeLabel(startYM,endYM){
            const fmt = ym => new Date(ym+'-02').toLocaleString('en-US',{month:'short'});
            return `${fmt(startYM)}–${fmt(endYM)} ${endYM.split('-')[0]}`;
        }
        
        function calculateQuarterlyIntensity(quarterRange) {
            const quarterMonths = monthsBetweenInclusive(quarterRange.start, quarterRange.end);
            const dataForQuarter = fullDataSeries.filter(d => quarterMonths.includes(d.ym));
            if(dataForQuarter.length < 1) return null;
            const totalProduction = dataForQuarter.reduce((sum, d) => sum + d.productionMTD, 0);
            const totalEmission = dataForQuarter.reduce((sum, d) => sum + d.totalAbsEmissionMTD, 0);
            return totalProduction > 0 ? (totalEmission / totalProduction) : 0;
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateMetrics(data) {
            if (!data) return;
            document.getElementById('overview-subtitle').textContent = data.overviewText;
            if (data.production) {
                updateProductionCard(data);
                document.getElementById('cs-production-period-text').textContent = data.production.periodLabel;
            }
        }

        function updateScrapCard(dataSubset) {
            if (!dataSubset || dataSubset.length === 0) {
                document.getElementById('scrap-input-value').textContent = 'N/A';
                return;
            }

            const latestDataPoint = dataSubset[dataSubset.length - 1];
            if(!latestDataPoint.productionMTD) { // Handle case like Sep 25 with no production
                 document.getElementById('scrap-input-value').textContent = 'N/A';
                 return;
            }
            const totalInternalScrap = latestDataPoint.internalScrap || 0;
            const totalExternalScrap = latestDataPoint.externalScrap || 0;
            const totalProduction = latestDataPoint.productionMTD || 0;

            const totalScrap = totalInternalScrap + totalExternalScrap;
            const scrapPercentage = totalProduction > 0 ? (totalScrap / totalProduction) * 100 : 0;

            document.getElementById('scrap-input-value').textContent = scrapPercentage.toFixed(1);
        }

        function updateProductionCard(data) {
            if (!data || !data.production) return;
            const unit = document.getElementById('unit-selector').value;
            const valueEl = document.getElementById('cs-production-value');
            valueEl.textContent = (unit === 'MnT') ? data.production.value : data.production.valueInTonnes.toLocaleString();
        }

        function setDynamicGreeting() {
            const greetingEl = document.getElementById('dynamic-greeting');
            if (!greetingEl) return;
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000;
            const istTime = new Date(now.getTime() + istOffset);
            const istHour = istTime.getUTCHours();
            let greetingText = '', iconSvg = '';

            if (istHour >= 5 && istHour < 12) {
                greetingText = 'Good Morning';
                iconSvg = `<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            } else if (istHour >= 12 && istHour < 17) {
                greetingText = 'Good Afternoon';
                iconSvg = `<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            } else if (istHour >= 17 && istHour < 21) {
                greetingText = 'Good Evening';
                iconSvg = `<svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10V3M12 21v-2m-7.07-2.93l1.41-1.41M4.93 4.93l1.41 1.41M21 12h-2M5 12H3m15.07 4.07l-1.41-1.41M17.66 6.34l-1.41 1.41M4 16h16"></path></svg>`;
            } else {
                greetingText = 'Good Night';
                iconSvg = `<svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
            }
            greetingEl.innerHTML = `${iconSvg}<span>${greetingText}</span>`;
        }

        // --- CHART RENDERING ---
        function getChartColors() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            return {
                gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                ticksColor: isDarkMode ? 'white' : '#374151',
                legendColor: isDarkMode ? 'white' : '#1f2937',
            };
        }

        function renderCo2Chart(data) {
            const co2Ctx = document.getElementById('co2LineChart').getContext('2d');
            if (co2LineChartInstance) co2LineChartInstance.destroy();
            const colors = getChartColors();
            co2LineChartInstance = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'CO2 Emissions Intensity', data: data.emissions, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.2)', tension: 0.4, fill: false, pointStyle: 'circle', pointRadius: 6, pointHoverRadius: 10 },
                        { label: 'Intensity Target', data: data.target, borderColor: 'rgb(75, 192, 192)', borderDash: [5, 5], tension: 0, fill: false, pointStyle: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } }
                    },
                    plugins: { 
                        legend: { 
                            position: 'top', align: 'start',
                            labels: { color: colors.legendColor, usePointStyle: true, filter: (item) => item.text !== 'Intensity Target' } 
                        },
                        datalabels: {
                           display: false
                        }
                    }
                }
            });
        }
        
        function renderProductionChart(view){
            const canvas = document.getElementById('prodChart');
            if(!canvas) return;

            const ctx = canvas.getContext('2d');
            if (prodChartInstance) prodChartInstance.destroy();
            const colors = getChartColors();

            if (view === 'ytd') {
                const selectedFY = getFY(selectedMonthYM);
                const fiscalYearData = fullDataSeries.filter(d => getFY(d.ym) === selectedFY && d.productionMTD);

                const labels = fiscalYearData.map(d => new Date(d.ym + '-02').toLocaleString('en-US', { month: 'short' }));
                const data = fiscalYearData.map(d => d.productionMTD);
                const bg = data.map(() => 'rgba(59,130,246,0.75)');
                const border = data.map(() => 'rgb(59,130,246)');
                 prodChartInstance = new Chart(ctx,{
                    type:'bar', data:{ labels, datasets:[{ data, backgroundColor:bg, borderColor:border, borderWidth:1 }]},
                    plugins: [ChartDataLabels],
                    options:{
                        responsive:true, maintainAspectRatio:false,
                        scales:{
                            y:{ beginAtZero:true, grid:{ color: colors.gridColor }, ticks:{ color: colors.ticksColor, callback:(v)=> (v/1e6).toFixed(1) }, suggestedMax: Math.max(...data) * 1.2 },
                            x:{ grid:{ display:true }, ticks: { color: colors.ticksColor } }
                        },
                        plugins:{ 
                            legend:{ display:false }, 
                            tooltip:{ callbacks:{ label:(ctx)=> (ctx.raw / 1e6).toFixed(2) + ' MnT' }},
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => (value / 1e6).toFixed(2),
                                color: colors.ticksColor,
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });

            } else {
                let labels = [], data = [], bg=[], border=[];
                
                if(view === 'monthly'){
                    const idx = fullDataSeries.findIndex(d => d.ym === selectedMonthYM);
                    const i = idx >= 0 ? idx : fullDataSeries.length - 1;
                    const start = Math.max(0, i - 2);
                    const subset = fullDataSeries.slice(start, i + 1).filter(d => d.productionMTD);
                    labels = subset.map(d => new Date(d.ym+'-02').toLocaleString('en-US',{month:'short'}));
                    data = subset.map(d => d.productionMTD);
                    const activeColor = '#5A95F8', lightShade = '#A9C7FB'; 
                    bg = subset.map((_,j) => j === subset.length-1 ? activeColor : lightShade);
                    border = subset.map((_,j) => j === subset.length-1 ? activeColor : lightShade);
                } else if(view === 'quarterly'){
                    const yms = monthsBetweenInclusive(lastQuarterUsed.startYM, lastQuarterUsed.endYM);
                    labels = yms.map(ym => new Date(ym+'-02').toLocaleString('en-US',{month:'short'}));
                    data = yms.map(ym => (fullDataSeries.find(r => r.ym === ym) || {ton:0}).productionMTD);
                    bg = yms.map(() => 'rgba(59,130,246,0.75)');
                    border = yms.map(() => 'rgb(59,130,246)');
                }
                
                prodChartInstance = new Chart(ctx,{
                    type:'bar', data:{ labels, datasets:[{ data, backgroundColor:bg, borderColor:border, borderWidth:1 }]},
                    plugins: [ChartDataLabels],
                    options:{
                        responsive:true, maintainAspectRatio:false,
                        scales:{
                            y:{ beginAtZero:true, grid:{ color: colors.gridColor }, ticks:{ color: colors.ticksColor, callback:(v)=> (v/1e6).toFixed(1) }, suggestedMax: Math.max(...data) * 1.2 },
                            x:{ grid:{ display:true }, ticks: { color: colors.ticksColor } }
                        },
                        plugins:{ 
                            legend:{ display:false }, 
                            tooltip:{ callbacks:{ label:(ctx)=> (ctx.raw / 1e6).toFixed(2) + ' MnT' }},
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => (value / 1e6).toFixed(2),
                                color: colors.ticksColor,
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            }
        }

        function renderScrapChart(dataSubset) {
            const ctx = document.getElementById('scrapChart').getContext('2d');
            if (scrapChartInstance) scrapChartInstance.destroy();
            const colors = getChartColors();
            
            const filteredSubset = dataSubset.filter(d => d.productionMTD);
            const labels = filteredSubset.map(d => new Date(d.ym + '-02').toLocaleString('en-US', { month: 'short' }));
            const internalData = filteredSubset.map(d => (d.internalScrap || 0) / 1000);
            const externalData = filteredSubset.map(d => (d.externalScrap || 0) / 1000);

            scrapChartInstance = new Chart(ctx, {
                type: 'bar',
                plugins: [ChartDataLabels],
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Internal',
                            data: internalData,
                            backgroundColor: 'rgb(234, 88, 12)', // Orange-600
                            borderColor: 'rgb(234, 88, 12)',
                            borderWidth: 1
                        },
                        {
                            label: 'External',
                            data: externalData,
                            backgroundColor: 'rgb(251, 146, 60)', // Orange-400
                            borderColor: 'rgb(251, 146, 60)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 20
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: { color: colors.gridColor },
                            ticks: { color: colors.ticksColor },
                            title: {
                                display: false
                            }
                        },
                        x: {
                            stacked: true,
                            grid: { display: false },
                            ticks: { color: colors.ticksColor, display: true }
                        }
                    },
                    plugins: {
                        legend: {
                           display:false
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toFixed(2)} KT`
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: colors.ticksColor,
                            font: { weight: 'bold' },
                            formatter: (value, context) => {
                                const datasets = context.chart.data.datasets;
                                if (context.datasetIndex === datasets.length - 1) {
                                    const total = datasets.reduce((sum, dataset) => sum + dataset.data[context.dataIndex], 0);
                                    return total.toFixed(1) + ' KT';
                                }
                                return '';
                            }
                        }
                    }
                }
            });
        }

        function renderEnergyCharts(dataSubset) {
            const placeholder = document.getElementById('energy-chart-placeholder');
            const gridContainer = document.getElementById('energy-chart-grid');
            
            Object.values(energyChartInstances).forEach(chart => chart && chart.destroy());

            const hasData = dataSubset.some(d => d.totalElectricity);

            if (!hasData) {
                gridContainer.classList.add('hidden');
                placeholder.classList.remove('hidden');
                return;
            }
            
            gridContainer.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            const colors = getChartColors();
            const newColors = {
                grid: '#6c5b80',
                renewable: '#f67481',
                self: '#f8c391'
            };

            const labels = dataSubset.map(d => new Date(d.ym + '-02').toLocaleString('en-US', { month: 'short' }));
            
            // --- 1. Composition (Pie Chart) ---
            const totalNonRenewableGrid = dataSubset.reduce((sum, d) => sum + ((d.gridElectricity || 0) - (d.renewableElectricity || 0)), 0);
            const totalRenewable = dataSubset.reduce((sum, d) => sum + (d.renewableElectricity || 0), 0);
            const totalSelf = dataSubset.reduce((sum, d) => sum + ((d.totalElectricity || 0) - (d.gridElectricity || 0)), 0);
            
            const pieCtx = document.getElementById('energyCompositionChart').getContext('2d');
            energyChartInstances.composition = new Chart(pieCtx, {
                type: 'pie',
                plugins: [ChartDataLabels],
                data: {
                    labels: ['Grid Power', 'RE from Grid', 'Captive'],
                    datasets: [{
                        data: [totalNonRenewableGrid, totalRenewable, totalSelf],
                        backgroundColor: [newColors.grid, newColors.renewable, newColors.self],
                        borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: colors.legendColor, font: {size: 10}, usePointStyle: true } },
                        datalabels: {
                            formatter: (value, ctx) => {
                                let sum = 0;
                                let dataArr = ctx.chart.data.datasets[0].data;
                                dataArr.map(data => {
                                    sum += data;
                                });
                                let percentage = (value*100 / sum).toFixed(1) + "%";
                                return percentage;
                            },
                            color: 'white',
                            backgroundColor: 'rgba(0, 0, 0, 0.5)',
                            borderRadius: 4,
                            padding: {
                                top: 2,
                                bottom: 2,
                                left: 4,
                                right: 4
                            },
                            font: {
                                weight: 'bold',
                            }
                        }
                    }
                }
            });

            // --- 2. Renewable % (Line Chart) ---
            const renewableCtx = document.getElementById('energyRenewableChart').getContext('2d');
            const renewablePercentageData = dataSubset.map(d => {
                if (renewableShareType === 'grid') {
                    return d.gridElectricity > 0 ? (d.renewableElectricity / d.gridElectricity) * 100 : 0;
                }
                return d.totalElectricity > 0 ? (d.renewableElectricity / d.totalElectricity) * 100 : 0;
            });
            const renewableLabel = renewableShareType === 'grid' ? 'Renewable % of Grid' : 'Renewable % of Total';

            energyChartInstances.renewable = new Chart(renewableCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: renewableLabel, data: renewablePercentageData, borderColor: newColors.renewable, tension: 0.3, pointStyle: 'circle', pointRadius: 6, pointHoverRadius: 8 },
                        { label: 'Target %', data: Array(labels.length).fill(33), borderColor: 'rgb(75, 192, 192)', borderDash: [5, 5], pointStyle: 'line' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor, callback: (v) => v.toFixed(0) + '%' } },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } }
                    },
                    plugins: { 
                        legend: { 
                            position: 'top', 
                            labels: { 
                                color: colors.legendColor, 
                                font: {size: 10},
                                usePointStyle: true, 
                            } 
                        },
                        datalabels: {
                           display: false
                        }
                    }
                }
            });

            // --- 3. Breakdown (Corrected Stacked Bar Chart) ---
            const breakdownCtx = document.getElementById('energyBreakdownChart').getContext('2d');
            const nonRenewableGridData = dataSubset.map(d => (d.gridElectricity || 0) - (d.renewableElectricity || 0));
            const renewableData = dataSubset.map(d => d.renewableElectricity || 0);
            const selfGeneratedData = dataSubset.map(d => (d.totalElectricity || 0) - (d.gridElectricity || 0));

            energyChartInstances.breakdown = new Chart(breakdownCtx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Grid Power', data: nonRenewableGridData, backgroundColor: newColors.grid },
                        { label: 'RE from Grid', data: renewableData, backgroundColor: newColors.renewable },
                        { label: 'Captive', data: selfGeneratedData, backgroundColor: newColors.self }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { 
                            stacked: true,
                            grid: { color: colors.gridColor }, 
                            ticks: { 
                                color: colors.ticksColor,
                                callback: function(value) {
                                    return (value / 1000) + 'K';
                                }
                            },
                        },
                        x: { 
                            stacked: true,
                            grid: { color: colors.gridColor }, 
                            ticks: { color: colors.ticksColor } 
                        }
                    },
                    plugins: { 
                        legend: { 
                            position: 'top', 
                            labels: { 
                                color: colors.legendColor, 
                                font: {size: 10},
                                usePointStyle: true,
                                pointStyle: 'rect'
                            } 
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.toLocaleString()} MWh`
                            }
                        },
                        datalabels: {
                            display: false
                        }
                    }
                }
            });
        }

        function renderWaterCharts(dataSubset) {
            if (waterIntensityChartInstance) waterIntensityChartInstance.destroy();
            if (waterBreakdownChartInstance) waterBreakdownChartInstance.destroy();

            const filteredData = dataSubset.filter(d => d.specificWaterConsumption != null);
            if (filteredData.length === 0) {
                // Hide charts if no data
                document.getElementById('waterIntensityChart').style.display = 'none';
                document.getElementById('waterBreakdownChart').style.display = 'none';
                return;
            } else {
                document.getElementById('waterIntensityChart').style.display = 'block';
                document.getElementById('waterBreakdownChart').style.display = 'block';
            }

            const colors = getChartColors();
            const labels = filteredData.map(d => new Date(d.ym + '-02').toLocaleString('en-US', { month: 'short' }));

            // 1. Water Intensity Line Chart (Specific Consumption)
            const intensityCtx = document.getElementById('waterIntensityChart').getContext('2d');
            waterIntensityChartInstance = new Chart(intensityCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Specific Consumption',
                        data: filteredData.map(d => d.specificWaterConsumption),
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } }
                    },
                    plugins: { legend: { display: false }, datalabels: { display: false } }
                }
            });

            // 2. Water Breakdown Stacked Bar Chart (Withdrawal vs Recycled)
            const breakdownCtx = document.getElementById('waterBreakdownChart').getContext('2d');
            waterBreakdownChartInstance = new Chart(breakdownCtx, { // Reusing the old instance variable name
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Recycled', data: filteredData.map(d => d.waterRecycled), backgroundColor: '#60a5fa' },
                        { label: 'Withdrawal', data: filteredData.map(d => d.waterWithdrawal), backgroundColor: '#2563eb' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { stacked: true, grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor, callback: v => (v/1e6).toFixed(1) + 'M' } },
                        x: { stacked: true, grid: { display: false }, ticks: { color: colors.ticksColor } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: colors.legendColor, usePointStyle: true, pointStyle: 'rect', font: {size: 10} } },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${(ctx.raw / 1000).toLocaleString()}K m³`
                            }
                        }
                    }
                }
            });
        }
        
        // --- MAIN DASHBOARD UPDATE FUNCTION ---
        function updateDashboard(view) {
            currentDataView = view;
            document.querySelectorAll('.time-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${view}`).classList.add('active');
            
            let currentData = dashboardData[view];
            let dataSubset = [];
            let periodLabelForTitles = '';

            if (view === 'monthly') {
                const idx = fullDataSeries.findIndex(d => d.ym === selectedMonthYM);
                const i = idx >= 0 ? idx : fullDataSeries.length - 1;
                const start = Math.max(0, i - 2); 
                dataSubset = fullDataSeries.slice(start, i + 1);
                periodLabelForTitles = toMonthLabel(selectedMonthYM).split(' ')[0];
            } else if (view === 'quarterly') {
                handleQuarterlySwitch(); // Recalculate quarterly data just in case month changed
                const qRange = lastQuarterUsed;
                if(qRange) {
                    const qMonths = monthsBetweenInclusive(qRange.startYM, qRange.endYM);
                    dataSubset = fullDataSeries.filter(d => qMonths.includes(d.ym));
                }
                periodLabelForTitles = dashboardData.quarterly.overviewText.replace(' Overview', '');
            } else if (view === 'ytd') {
                const latestDataPoint = fullDataSeries.find(d => d.productionMTD); // Find last month with production
                const latestFY = getFY(latestDataPoint.ym);
                const selectedFY = getFY(selectedMonthYM);

                let ytdProductionData, ytdLabel, overviewText;
                
                const fiscalYearData = fullDataSeries.filter(d => getFY(d.ym) === selectedFY);
                dataSubset = fiscalYearData;
                
                if (selectedFY < latestFY) {
                    ytdProductionData = fiscalYearData.reduce((sum, d) => sum + (d.productionMTD || 0), 0);
                    ytdLabel = `Total for ${selectedFY}`;
                    overviewText = `${selectedFY} Overview`;
                } else {
                    ytdProductionData = fiscalYearData.reduce((sum, d) => sum + (d.productionMTD || 0), 0);
                    const latestMonthName = toMonthLabel(latestDataPoint.ym).split(' ')[0];
                    ytdLabel = `YTD for ${latestFY} (till ${latestMonthName})`;
                    overviewText = `${latestFY} YTD Overview`;
                }

                dashboardData.ytd.production.valueInTonnes = +ytdProductionData.toFixed(2);
                dashboardData.ytd.production.value = +(ytdProductionData / 1e6).toFixed(2);
                dashboardData.ytd.production.periodLabel = ytdLabel;
                dashboardData.ytd.overviewText = overviewText;
                currentData = dashboardData.ytd;
                periodLabelForTitles = currentData.overviewText.replace(' Overview', '');
            }

            updateMetrics(currentData);
            updateScrapCard(dataSubset);
            
            // --- Chart Updates ---
            let co2ChartData;
            const co2Subtitle = document.getElementById('co2-intensity-subtitle');
            const insightsTitle = document.getElementById('insights-title');
            
            const co2Subset = dataSubset.filter(d => d.productionMTD);

            if (view === 'monthly') {
                co2Subtitle.textContent = 'vs Target: 2.09 tCO₂/tcs';
                const record = fullDataSeries.find(r => r.ym === selectedMonthYM);
                
                if (record && record.productionMTD) {
                    co2ChartData = {
                        labels: co2Subset.map(d => new Date(d.ym+'-02').toLocaleString('en-US',{month:'short'})),
                        emissions: co2Subset.map(d => d.totalAbsEmissionMTD / d.productionMTD),
                        target: co2Subset.map(() => 2.09) 
                    };
                    const latestIntensity = record.totalAbsEmissionMTD / record.productionMTD;
                    document.getElementById('co2-intensity-value').textContent = latestIntensity.toFixed(2);
                } else {
                    co2ChartData = { labels: [], emissions: [], target: [] };
                    document.getElementById('co2-intensity-value').textContent = 'N/A';
                }


            } else if (view === 'ytd') {
                const allFYs = [...new Set(fullDataSeries.filter(d=>d.productionMTD).map(d => getFY(d.ym)))].sort();
    
                if (allFYs.length >= 2) {
                    const latestFY = allFYs[allFYs.length - 1];
                    const previousFY = allFYs[allFYs.length - 2];

                    const previousFYData = fullDataSeries.filter(d => getFY(d.ym) === previousFY);
                    const latestFYData = fullDataSeries.filter(d => getFY(d.ym) === latestFY);

                    const previousFYTotalProd = previousFYData.reduce((sum, d) => sum + (d.productionMTD || 0), 0);
                    const previousFYTotalEmission = previousFYData.reduce((sum, d) => sum + (d.totalAbsEmissionMTD || 0), 0);
                    const previousFYIntensity = previousFYTotalEmission / previousFYTotalProd;

                    const latestFYTotalProd = latestFYData.reduce((sum, d) => sum + (d.productionMTD || 0), 0);
                    const latestFYTotalEmission = latestFYData.reduce((sum, d) => sum + (d.totalAbsEmissionMTD || 0), 0);
                    const latestFYIntensity = latestFYTotalEmission / latestFYTotalProd;
                    
                    const selectedFY = getFY(selectedMonthYM);
                    const fiscalYearData = fullDataSeries.filter(d => getFY(d.ym) === selectedFY && d.productionMTD);
                    const selectedMonthIndex = fiscalYearData.findIndex(d => d.ym === selectedMonthYM);
                    const ytdData = fiscalYearData.slice(0, selectedMonthIndex + 1);
                    const ytdProd = ytdData.reduce((sum, d) => sum + (d.productionMTD || 0), 0);
                    const ytdEmission = ytdData.reduce((sum, d) => sum + (d.totalAbsEmissionMTD || 0), 0);
                    const ytdIntensity = (ytdEmission / ytdProd).toFixed(2);
                    const selectedMonthLabel = toMonthLabel(selectedMonthYM).split(' ')[0];
                    
                    co2Subtitle.textContent = `${ytdIntensity} tCO₂/tcs (${selectedFY.replace('20','')} ${selectedMonthLabel} YTD)`;

                    co2ChartData = {
                        labels: [previousFY.replace('20',''), `YTD ${latestFY.replace('20','')}`],
                        emissions: [previousFYIntensity, latestFYIntensity],
                        target: [2.09, 2.09]
                    };
                    document.getElementById('co2-intensity-value').textContent = latestFYIntensity.toFixed(2);
                } else {
                    co2ChartData = { labels: [], emissions: [], target: [] };
                    co2Subtitle.textContent = 'Not enough data for YTD comparison';
                    document.getElementById('co2-intensity-value').textContent = 'N/A';
                }
            } else if (view === 'quarterly') {
                co2ChartData = dashboardData.quarterly.co2;
                document.getElementById('co2-intensity-value').textContent = co2ChartData.average;
                co2Subtitle.textContent = `${co2ChartData.title} Average Intensity`;
            }
            
            if(insightsTitle) {
                insightsTitle.textContent = `${periodLabelForTitles} Highlights & Insights`;
            }
            // Update Energy & Water cards
            const intensityRecord = fullDataSeries.find(d => d.ym === selectedMonthYM);
            document.getElementById('energy-intensity-subtitle').textContent = toMonthLabel(selectedMonthYM);
            if (intensityRecord && intensityRecord.totalElectricity && intensityRecord.productionMTD) {
                const energyIntensity = intensityRecord.totalElectricity / intensityRecord.productionMTD;
                document.getElementById('energy-intensity-value').textContent = energyIntensity.toFixed(2);
            } else {
                document.getElementById('energy-intensity-value').textContent = "N/A";
            }
            document.getElementById('water-intensity-subtitle').textContent = toMonthLabel(selectedMonthYM);
             if (intensityRecord && intensityRecord.specificWaterConsumption) {
                document.getElementById('water-intensity-value').textContent = intensityRecord.specificWaterConsumption.toFixed(2);
            } else {
                document.getElementById('water-intensity-value').textContent = "N/A";
            }

             // Rainwater Harvested YTD Calculation
            const { y: selectedY, m: selectedM } = ymToParts(selectedMonthYM);
            const fyForRainwater = getFY(selectedMonthYM) || 'FY2025';

            const rainwaterYTD = fullDataSeries
                .filter(d => getFY(d.ym) === fyForRainwater && d.rainwaterHarvested != null)
                .reduce((sum, d) => sum + d.rainwaterHarvested, 0);
            
            document.getElementById('rainwater-harvested-value').textContent = rainwaterYTD.toLocaleString();
            document.getElementById('rainwater-harvested-subtitle').textContent = `m³ (${fyForRainwater.replace('20','')} YTD)`;
            
            const [year, month] = selectedMonthYM.split('-');
            const monthName = new Date(selectedMonthYM + '-02').toLocaleString('en-US', { month: 'long' });
            const shortYear = year.substring(2);
            const formattedDate = `(${monthName}'${shortYear})`;
            const compositionTitleEl = document.getElementById('composition-title');
            compositionTitleEl.innerHTML = `Composition <span class="text-base font-normal text-gray-500 dark:text-gray-400">${formattedDate}</span>`;


            renderCo2Chart(co2ChartData);
            renderProductionChart(view);
            renderScrapChart(dataSubset);
            renderEnergyCharts(dataSubset);
            renderWaterCharts(dataSubset);
        }

        function handleQuarterlySwitch(){
            let pastQuartersData = [];
            let currentQuarter = quarterRangeForYM(selectedMonthYM);

            for (let i = 0; i < 3; i++) {
                if (currentQuarter && hasAllMonths(currentQuarter.start, currentQuarter.end)) {
                    const intensity = calculateQuarterlyIntensity(currentQuarter);
                    const quarterMonths = monthsBetweenInclusive(currentQuarter.start, currentQuarter.end);
                    const dataForQuarter = fullDataSeries.filter(d => quarterMonths.includes(d.ym));

                    if (intensity !== null) {
                        pastQuartersData.unshift({ 
                            label: `${currentQuarter.fy.replace('20','')} Q${currentQuarter.q}`, 
                            intensity: intensity, 
                            range: currentQuarter,
                            data: dataForQuarter
                        });
                    }
                    currentQuarter = previousQuarterRangeForYM(currentQuarter.start);
                } else { break; }
            }
            
            if (pastQuartersData.length > 0) {
                const mostRecentQuarter = pastQuartersData[pastQuartersData.length - 1];
                dashboardData.quarterly.co2 = {
                    labels: pastQuartersData.map(q => q.label), emissions: pastQuartersData.map(q => q.intensity),
                    target: pastQuartersData.map(() => 2.09), average: mostRecentQuarter.intensity.toFixed(2), title: mostRecentQuarter.label
                };

                const { start, end, q, fy } = mostRecentQuarter.range;
                const totalProduction = mostRecentQuarter.data.reduce((sum, d) => sum + d.productionMTD, 0);
                lastQuarterUsed = { startYM: start, endYM: end };
                
                dashboardData.quarterly.overviewText = `${fy} Q${q} Overview`;
                dashboardData.quarterly.production.valueInTonnes = +totalProduction.toFixed(2);
                dashboardData.quarterly.production.value = +(totalProduction / 1e6).toFixed(2);
                dashboardData.quarterly.production.periodLabel = `${fy} Q${q} (${rangeLabel(start, end)})`;
            }
        }

        function updateMonthlyFor(ym) {
            selectedMonthYM = ym;
            const rec = fullDataSeries.find(r => r.ym === ym);
            if (!rec) return;
            const selLabel = toMonthLabel(ym);
            dashboardData.monthly.overviewText = `${selLabel} Overview`;
            if (rec.productionMTD) {
                dashboardData.monthly.production.valueInTonnes = +rec.productionMTD.toFixed(2);
                dashboardData.monthly.production.value = +(rec.productionMTD / 1e6).toFixed(2);
            } else {
                 dashboardData.monthly.production.valueInTonnes = 0;
                dashboardData.monthly.production.value = 0;
            }
            dashboardData.monthly.production.periodLabel = selLabel;
            updateDashboard('monthly');
        }

        // --- MONTH POPOVER LOGIC ---
        function buildMonthPopover() {
            const wrap = document.getElementById('month-popover-content');
            if (!wrap) return;
            wrap.innerHTML = '';
            ['FY2026','FY2025'].forEach((fy, idx) => {
                const section = document.createElement('div');
                section.className = idx === 0 ? 'mb-3' : 'mt-4';
                const h = document.createElement('div');
                h.className = 'text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2';
                h.textContent = fy;
                section.appendChild(h);
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-3 gap-2';
                
                const startYear = parseInt(fy.replace('FY','')) - 1;
                const months = Array.from({length: 12}, (_, i) => {
                    const month = (i + 3) % 12 + 1;
                    const year = startYear + Math.floor((i + 3) / 12);
                    return toYM(year, month);
                });
                const monthNames = ['Apr','May','Jun','Jul','Aug','Sept','Oct','Nov','Dec','Jan','Feb','Mar'];

                months.forEach((ym, i) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.dataset.ym = ym;
                    btn.textContent = monthNames[i];
                    btn.className = 'px-3 py-1.5 rounded-full text-sm font-semibold transition select-none';
                    if (AVAILABLE_MONTHS.has(ym)) {
                        btn.className += (ym === selectedMonthYM)
                            ? ' bg-green-500 text-white'
                            : ' text-gray-800 dark:text-gray-100 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700';
                        btn.addEventListener('click', () => {
                            updateMonthlyFor(ym);
                            if(currentDataView === 'quarterly') updateDashboard('quarterly');
                            else if (currentDataView === 'ytd') { updateDashboard('ytd'); } 
                            
                            buildMonthPopover(); // Rebuild to update active state
                            closeMonthPopover();
                        });
                    } else {
                        btn.className += ' text-gray-400 bg-gray-100/40 dark:bg-gray-800/40 cursor-not-allowed';
                        btn.disabled = true;
                    }
                    grid.appendChild(btn);
                });
                section.appendChild(grid);
                wrap.appendChild(section);
            });
        }
        function closeMonthPopover() {
            document.getElementById('month-popover').classList.add('hidden');
            document.getElementById('month-popover-btn').setAttribute('aria-expanded','false');
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            Chart.register(ChartDataLabels);
            // Beta Overlay
            const betaOverlay = document.getElementById('beta-overlay');
            const betaModal = document.getElementById('beta-modal');
            setTimeout(() => {
                betaModal.classList.remove('scale-95', 'opacity-0');
                betaModal.classList.add('scale-100', 'opacity-100');
            }, 100);
            document.getElementById('dismiss-beta').addEventListener('click', () => {
                betaOverlay.style.opacity = 0;
                setTimeout(() => {
                    betaOverlay.style.display = 'none';
                }, 300);
            });

            // Set dynamic greeting
            setDynamicGreeting();

            // Initial dashboard render
            updateDashboard('monthly');

            // Attach event listeners
            document.getElementById('filter-monthly').addEventListener('click', () => updateDashboard('monthly'));
            document.getElementById('filter-quarterly').addEventListener('click', () => updateDashboard('quarterly'));
            document.getElementById('filter-ytd').addEventListener('click', () => updateDashboard('ytd'));
            document.getElementById('unit-selector').addEventListener('change', () => updateProductionCard(dashboardData[currentDataView]));
            
            document.getElementById('re-toggle-container').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON'){
                    const type = e.target.dataset.type;
                    if(type && type !== renewableShareType) {
                        renewableShareType = type;
                        document.querySelectorAll('.re-toggle-btn').forEach(btn => btn.classList.remove('active', 'bg-white', 'dark:bg-gray-600'));
                        e.target.classList.add('active', 'bg-white', 'dark:bg-gray-600');
                        updateDashboard(currentDataView);
                    }
                }
            });


            // Month popover interactions
            const monthBtn = document.getElementById('month-popover-btn');
            const monthPop = document.getElementById('month-popover');
            monthBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (monthPop.classList.contains('hidden')) {
                    buildMonthPopover();
                    monthPop.classList.remove('hidden');
                    monthBtn.setAttribute('aria-expanded','true');
                } else {
                    closeMonthPopover();
                }
            });
            document.addEventListener('click', (e) => !monthPop.classList.contains('hidden') && !monthPop.contains(e.target) && e.target !== monthBtn && closeMonthPopover());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && closeMonthPopover());

            // Download functionality
            const downloadBtn = document.getElementById('download-btn');
            const downloadMenu = document.getElementById('download-menu');
            downloadBtn.addEventListener('click', (e) => { e.stopPropagation(); downloadMenu.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => !downloadMenu.classList.contains('hidden') && !downloadMenu.contains(e.target) && e.target !== downloadBtn && downloadMenu.classList.add('hidden'));

            const captureDashboard = () => {
                const elementsToHide = [document.getElementById('beta-overlay'), downloadBtn, downloadMenu, document.getElementById('month-popover-btn'), document.getElementById('theme-toggle'), document.getElementById('share-btn')];
                elementsToHide.forEach(el => el && (el.style.visibility = 'hidden'));
                return html2canvas(document.getElementById('dashboard-container')).finally(() => elementsToHide.forEach(el => el && (el.style.visibility = 'visible')));
            }

            document.getElementById('download-png').addEventListener('click', (e) => {
                e.preventDefault();
                captureDashboard().then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'esg-pulse-monitor.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
                downloadMenu.classList.add('hidden');
            });

            // Share functionality
            const shareBtn = document.getElementById('share-btn');
            shareBtn.addEventListener('click', () => {
                const subject = encodeURIComponent('Check out the AM/NS India ESG Pulse Monitor');
                const url = 'https://arcelormittal.sharepoint.com/sites/amnsindia-sustainability/SitePages/Dashboard-Advanced.aspx';
                const body = encodeURIComponent(`Hi,\n\nPlease find the link to the ESG Pulse Monitor dashboard below:\n\n${url}\n\nThanks`);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            });
        };
    </script>
</body>
</html>

