<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Class for dark mode toggling -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AM/NS India - ESG Pulse Monitor</title>
    <!-- Inter font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Libraries for Downloading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Tailwind config for dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
             overflow-x: hidden;
        }
        .filter-btn {
            background-color: #E5E7EB; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, transform 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
        }
        .dark .filter-btn {
            background-color: #4B5563; /* gray-600 */
            color: #F3F4F6; /* gray-100 */
        }
        .filter-btn:hover {
            background-color: #D1D5DB; /* gray-300 */
            transform: translateY(-2px);
        }
        .dark .filter-btn:hover {
             background-color: #6B7280; /* gray-500 */
        }
        .filter-btn.active {
            background-color: #10B981; /* green-500 */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .time-filter-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 9999px; /* pill shape */
            font-weight: 600;
            transition: all 0.2s;
            background-color: transparent;
            color: #374151;
            border: none;
        }
        .dark .time-filter-btn {
            color: #F3F4F6;
        }
        .time-filter-btn:hover:not(.active) {
            background-color: #D1D5DB;
        }
        .dark .time-filter-btn:hover:not(.active) {
            background-color: #4B5563;
        }
        .time-filter-btn.active {
            background-color: #10B981;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 p-6 sm:p-10 transition-colors duration-300">

    <!-- BETA Overlay -->
    <div id="beta-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4 transform transition-all duration-300 scale-95 opacity-0" id="beta-modal">
            <h3 class="text-2xl font-bold text-yellow-500 mb-4">BETA Testing</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-6">This dashboard is currently in a testing phase. The data displayed is for demonstration purposes only and should not be used for official reference.</p>
            <button id="dismiss-beta" class="bg-indigo-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Acknowledge & Continue</button>
        </div>
    </div>

    <!-- Header Section -->
    <header class="relative text-center mb-12">
        <h2 class="text-3xl sm:text-4xl font-extrabold text-gray-700 dark:text-gray-300 tracking-wider mb-2">AM/NS INDIA</h2>
        <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight mb-2 text-gray-900 dark:text-white">
            ESG Pulse Monitor
        </h1>
        <p id="overview-subtitle" class="text-xl text-gray-500 dark:text-gray-400">July 2025 Overview</p>
        <div id="dynamic-greeting" class="flex items-center justify-center gap-2 text-lg text-gray-500 dark:text-gray-400 mt-1"></div>

        <!-- Download Button -->
        <div class="absolute top-0 left-0">
            <div class="relative">
                <button id="download-btn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                </button>
                <div id="download-menu" class="hidden absolute left-0 mt-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-20">
                    <a href="#" id="download-png" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Download as PNG</a>
                    <a href="#" id="download-pdf" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700">Download as PDF</a>
                </div>
            </div>
        </div>

        <!-- Right side buttons -->
        <div class="absolute top-0 right-0 flex items-center gap-3">
            <!-- Custom Month Popover -->
            <div class="relative">
                <button id="month-popover-btn" aria-expanded="false" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 ring-2 ring-indigo-300/60 hover:ring-indigo-500 focus:outline-none focus:ring-4 focus:ring-indigo-500/30 transition">
                    <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </button>
                <div id="month-popover" class="hidden absolute right-0 mt-3 w-80 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl p-4 z-50">
                    <div id="month-popover-content"></div>
                </div>
            </div>

            <!-- Theme Toggle Button -->
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg id="theme-icon-light" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="theme-icon-dark" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Filter Buttons for Monthly, Quarterly, YTD -->
    <div class="flex justify-center mb-8">
        <div class="inline-flex p-1 bg-gray-200 dark:bg-gray-700 rounded-full">
            <button id="filter-monthly" class="time-filter-btn active">Monthly</button>
            <button id="filter-quarterly" class="time-filter-btn">Quarterly</button>
            <button id="filter-ytd" class="time-filter-btn">YTD</button>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-12">
        
        <!-- CO2 Intensity Card -->
        <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col">
            <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">BETA: Do not refer or share externally</p>
            </div>
            <div class="absolute top-4 right-4 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                    Placeholder for CO2 Intensity information.
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-2 text-cyan-600 dark:text-cyan-400">CO2 Intensity</h2>
                <p class="text-5xl font-bold mb-1">
                    <span id="co2-intensity-value">2.13</span> 
                    <span class="text-2xl text-gray-500 dark:text-gray-400">tCO₂/tcs</span>
                </p>
                <p id="co2-intensity-subtitle" class="text-md text-gray-500 dark:text-gray-400 mb-2">vs Target: 2.09 tCO₂/tcs</p>
            </div>
            <div class="flex-grow">
                <canvas id="co2LineChart"></canvas>
            </div>
        </div>

        <!-- Crude Steel Production Card -->
        <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col justify-between">
            <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">BETA: Do not refer or share externally</p>
            </div>
            <div class="absolute top-4 right-4 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                    Placeholder for Crude Steel Production information.
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-2 text-lime-600 dark:text-lime-400">Crude Steel Production</h2>
                <div class="flex items-baseline">
                    <p class="text-5xl font-bold mb-1">
                        <span id="cs-production-value">0.64</span> 
                    </p>
                    <div class="relative ml-2">
                        <select id="unit-selector" class="bg-gray-200 dark:bg-gray-700 text-2xl text-gray-500 dark:text-gray-400 rounded-md p-1 pr-8 focus:outline-none appearance-none">
                            <option value="MnT">MnT</option>
                            <option value="t">t</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-gray-400">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>
                <p id="cs-production-period-text" class="text-md text-gray-500 dark:text-gray-400">July 2025</p>
            </div>
            <div class="mt-4 flex flex-col items-center flex-grow">
                <!-- Mini bar chart: last 3 months / selected quarter -->
                <div id="prodChartWrap" class="w-full flex-grow">
                    <canvas id="prodChart" class="w-full h-full"></canvas>
                </div>
            </div>
        </div>

        <!-- Scrap Input Card -->
        <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg flex flex-col justify-between">
            <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">BETA: Do not refer or share externally</p>
            </div>
            <div class="absolute top-4 right-4 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                    Placeholder for Scrap Input information.
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-2 text-orange-600 dark:text-orange-400">Scrap Input</h2>
                <p class="text-5xl font-bold mb-1">
                    <span id="scrap-input-value">6.0</span> 
                    <span class="text-2xl text-gray-500 dark:text-gray-400">%</span>
                </p>
                <p class="text-md text-gray-500 dark:text-gray-400">vs Target: 7.1%</p>
            </div>
            <div class="mt-4">
                <div class="w-full flex justify-between items-center text-sm">
                    <div class="flex-1 text-center">
                        <span id="external-scrap" class="block text-2xl font-bold text-gray-800 dark:text-gray-300">7.89</span>
                        <span class="block text-gray-600 dark:text-gray-500">External KT</span>
                    </div>
                    <div class="flex-1 text-center">
                        <span id="internal-scrap" class="block text-2xl font-bold text-gray-800 dark:text-gray-300">29.07</span>
                        <span class="block text-gray-600 dark:text-gray-500">Internal KT</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Detailed Charts Section -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
        
        <!-- Down Stream Emission Intensity Chart -->
        <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg">
            <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">BETA: Do not refer or share externally</p>
            </div>
            <div class="absolute top-4 right-4 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                    Placeholder for Down Stream Emission information.
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                </div>
            </div>
            <h2 id="downstream-chart-title" class="text-xl font-semibold mb-4 text-pink-600 dark:text-pink-400">Down Stream Emission Intensity (July)</h2>
            <div id="downstream-filter-container" class="flex space-x-2 mb-4">
                <button class="filter-btn active" data-location="all">All Locations</button>
                <button class="filter-btn" data-location="pune">Pune</button>
                <button class="filter-btn" data-location="khopoli">Khopoli</button>
                <button class="filter-btn" data-location="gandhidham">Gandhidham</button>
            </div>
            <div class="chart-container">
                <canvas id="downstreamBarChart"></canvas>
            </div>
        </div>

        <!-- CSR Beneficiaries Donut Chart -->
        <div class="relative bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 pt-12 shadow-lg">
             <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
                <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">BETA: Do not refer or share externally</p>
            </div>
            <div class="absolute top-4 right-4 group">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                    Placeholder for CSR Beneficiaries information.
                    <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
                </div>
            </div>
            <h2 id="csr-chart-title" class="text-xl font-semibold mb-4 text-purple-600 dark:text-purple-400">CSR Beneficiaries (July)</h2>
            <div class="chart-container">
                <canvas id="csrDonutChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Insights & Summary Section -->
    <section class="relative bg-gray-200 dark:bg-gray-800 rounded-xl p-6 pt-12 shadow-lg mb-12">
        <div class="absolute top-0 left-0 right-0 bg-yellow-100 dark:bg-yellow-900/50 p-1 border-b border-yellow-200 dark:border-yellow-800 text-center rounded-t-xl">
            <p class="text-xs font-semibold text-yellow-800 dark:text-yellow-300">BETA: Do not refer or share externally</p>
        </div>
        <div class="absolute top-4 right-4 group">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 cursor-pointer" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-64 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                Placeholder for Highlights & Insights information.
                <div class="absolute top-full left-1/2 -translate-x-1/2 w-0 h-0 border-x-8 border-x-transparent border-t-8 border-t-gray-700"></div>
            </div>
        </div>
        <h2 id="insights-title" class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">July 2025 Highlights & Insights</h2>
        <ul id="insights-list" class="list-disc list-inside space-y-2 text-gray-700 dark:text-gray-300">
            <li><span class="font-medium text-green-600 dark:text-green-300">Target Met:</span> The RE from Grid target of 33% was successfully achieved.</li>
            <li><span class="font-medium text-orange-600 dark:text-orange-300">Scrap Input Increase:</span> Scrap input percentage increased from 5.6% in June to 6.0% in July.</li>
            <li><span class="font-medium text-blue-600 dark:text-blue-300">High Water Reuse:</span> Over 5 lakh cubic meters of water were recycled and reused.</li>
            <li><span class="font-medium text-red-600 dark:text-red-300">Increased CO2 Intensity:</span> CO2 Intensity increased to 2.13 tCO₂/tcs, moving further away from the target.</li>
            <li><span class="font-medium text-purple-600 dark:text-purple-300">Significant Beneficiaries:</span> CSR initiatives reached over 1.7 lakh people in the health sector.</li>
        </ul>
    </section>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        let downstreamBarChartInstance = null;
        let co2LineChartInstance = null;
        let csrDonutChartInstance = null;
        let prodChartInstance = null;
        let lastQuarterUsed = null;
        let currentDataView = 'monthly';
        let selectedMonthYM = '2025-07'; // Initialize with a default
        let currentDownstreamLocation = 'all';

        // --- THEME TOGGLE LOGIC ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        function setAutoTheme() {
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000;
            const istTime = new Date(now.getTime() + istOffset);
            const istHour = istTime.getUTCHours();
            const isNight = istHour >= 17 || istHour < 6;

            document.documentElement.classList.remove('dark', 'light');
            
            if (isNight) {
                document.documentElement.classList.add('dark');
                darkIcon.classList.remove('hidden');
                lightIcon.classList.add('hidden');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.classList.add('light');
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            }
        }
        
        setAutoTheme(); // Run auto-theme on initial load

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            lightIcon.classList.toggle('hidden');
            darkIcon.classList.toggle('hidden');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateDashboard(currentDataView); // Re-render charts with updated colors
        });


        // --- DATA STORE ---
        // Raw time-series data, simulating a database table
        const fullDataSeries = [
            { ym: '2024-01', productionMTD: 668528.00, totalAbsEmissionMTD: 1482810.00 },
            { ym: '2024-02', productionMTD: 637899.00, totalAbsEmissionMTD: 1394002.00 },
            { ym: '2024-03', productionMTD: 678052.00, totalAbsEmissionMTD: 1440466.00 },
            { ym: '2024-04', productionMTD: 653105.00, totalAbsEmissionMTD: 1410577.00 },
            { ym: '2024-05', productionMTD: 628778.00, totalAbsEmissionMTD: 1377834.00 },
            { ym: '2024-06', productionMTD: 583100.00, totalAbsEmissionMTD: 1310694.00 },
            { ym: '2024-07', productionMTD: 588554.00, totalAbsEmissionMTD: 1337874.00 },
            { ym: '2024-08', productionMTD: 631284.00, totalAbsEmissionMTD: 1368522.00 },
            { ym: '2024-09', productionMTD: 523245.00, totalAbsEmissionMTD: 1163087.00 },
            { ym: '2024-10', productionMTD: 661370.00, totalAbsEmissionMTD: 1356894.00 },
            { ym: '2024-11', productionMTD: 654595.00, totalAbsEmissionMTD: 1331781.00 },
            { ym: '2024-12', productionMTD: 633637.00, totalAbsEmissionMTD: 1363499.00 },
            { ym: '2025-01', productionMTD: 530428.00, totalAbsEmissionMTD: 1128120.00 },
            { ym: '2025-02', productionMTD: 549687.00, totalAbsEmissionMTD: 1154141.00 },
            { ym: '2025-03', productionMTD: 603752.00, totalAbsEmissionMTD: 1332623.00 },
            { ym: '2025-04', productionMTD: 596980.00, totalAbsEmissionMTD: 1245932.00 },
            { ym: '2025-05', productionMTD: 587534.07, totalAbsEmissionMTD: 1265043.00 },
            { ym: '2025-06', productionMTD: 644157.05, totalAbsEmissionMTD: 1336695.00 },
            { ym: '2025-07', productionMTD: 637576.00, totalAbsEmissionMTD: 1356904.00 },
        ];
        selectedMonthYM = fullDataSeries[fullDataSeries.length - 1].ym; // Set latest month on load

        // Pre-calculated/static data for different views
        const dashboardData = {
            monthly: {
                overviewText: 'July 2025 Overview',
                production: { value: 0.64, valueInTonnes: 637576, periodLabel: 'July 2025' },
                scrap: { value: 6.0, target: 7.1, external: 7.89, internal: 29.07 },
                downstreamEmissions: {
                    all: { labels: ['Pune', 'Khopoli', 'Gandhidham'], values: [0.04, 0.17, 0.15] },
                    pune: { labels: ['Galvanised', 'Cold Rolled'], values: [0.03, 0.05] },
                    khopoli: { labels: ['Coated Steel', 'Tubes'], values: [0.18, 0.16] },
                    gandhidham: { labels: ['Pipes', 'Structural'], values: [0.14, 0.16] }
                },
                csr: { beneficiaries: { health: 170793, education: 96294, skill: 28051, environment: 3900, community: 12800, sports: 27077 } }
            },
            quarterly: {
                overviewText: 'Q2 FY25 Overview',
                co2: { labels: [], emissions: [], target: [], average: 0 },
                production: { value: 1.83, valueInTonnes: 1828671, periodLabel: 'Q2 FY25' },
                scrap: { value: 6.2, target: 7.1, external: 23.50, internal: 85.10 },
                downstreamEmissions: {
                    all: { labels: ['Pune', 'Khopoli', 'Gandhidham'], values: [0.05, 0.16, 0.14] },
                    pune: { labels: ['Galvanised', 'Cold Rolled'], values: [0.04, 0.06] },
                    khopoli: { labels: ['Coated Steel', 'Tubes'], values: [0.17, 0.15] },
                    gandhidham: { labels: ['Pipes', 'Structural'], values: [0.13, 0.15] }
                },
                csr: { beneficiaries: { health: 450000, education: 280000, skill: 75000, environment: 11000, community: 38000, sports: 80000 } }
            },
            ytd: {
                overviewText: 'Year-to-Date Overview',
                production: { value: 2.47, valueInTonnes: 2466247.12, periodLabel: 'April 2025 to latest month' },
                scrap: { value: 5.9, target: 7.1, external: 54.20, internal: 210.30 },
                downstreamEmissions: {
                    all: { labels: ['Pune', 'Khopoli', 'Gandhidham'], values: [0.04, 0.17, 0.16] },
                    pune: { labels: ['Galvanised', 'Cold Rolled'], values: [0.03, 0.05] },
                    khopoli: { labels: ['Coated Steel', 'Tubes'], values: [0.18, 0.16] },
                    gandhidham: { labels: ['Pipes', 'Structural'], values: [0.15, 0.17] }
                },
                csr: { beneficiaries: { health: 1200000, education: 850000, skill: 220000, environment: 32000, community: 105000, sports: 240000 } }
            }
        };

        // --- DATA HELPERS & CALCULATORS ---
        const toMonthLabel = (ym) => new Date(ym + '-02').toLocaleString('en-US', { month: 'long', year: 'numeric' });
        const AVAILABLE_MONTHS = new Set(fullDataSeries.map(d => d.ym));
        
        function ymToParts(ym){ const [y,m] = ym.split('-').map(Number); return {y, m}; }
        function toYM(y,m){ return `${y}-${String(m).padStart(2,'0')}`; }
        function getFY(ym) {
            const [year, month] = ym.split('-').map(Number);
            return month >= 4 ? `FY${year + 1}` : `FY${year}`;
        }
        function quarterFromMonth(m){ if(m>=4&&m<=6) return 1; if(m>=7&&m<=9) return 2; if(m>=10&&m<=12) return 3; return 4; }
        
        function quarterRangeForYM(ym){
            const {y,m} = ymToParts(ym); const q = quarterFromMonth(m);
            const fy = getFY(ym);
            if(q===1){ return { start: toYM(y,4), end: toYM(y,6), q, fy }; }
            if(q===2){ return { start: toYM(y,7), end: toYM(y,9), q, fy }; }
            if(q===3){ return { start: toYM(y,10), end: toYM(y,12), q, fy }; }
            return { start: toYM(y,1), end: toYM(y,3), q: 4, fy };
        }
        
        function previousQuarterRangeForYM(ym){
            let {y,m} = ymToParts(ym);
            m -= 3;
            if (m < 1) { m += 12; y -= 1; }
            return quarterRangeForYM(toYM(y, m));
        }

        function monthsBetweenInclusive(startYM,endYM){
            const out=[]; let {y:ys,m:ms}=ymToParts(startYM); const {y:ye,m:me}=ymToParts(endYM);
            while(ys<ye || (ys===ye && ms<=me)){ out.push(toYM(ys,ms)); ms++; if(ms>12){ ms=1; ys++; } }
            return out;
        }
        function hasAllMonths(startYM,endYM){ return monthsBetweenInclusive(startYM,endYM).every(ym => AVAILABLE_MONTHS.has(ym)); }
        function rangeLabel(startYM,endYM){
            const fmt = ym => new Date(ym+'-02').toLocaleString('en-US',{month:'short'});
            return `${fmt(startYM)}–${fmt(endYM)} ${endYM.split('-')[0]}`;
        }
        
        function calculateQuarterlyIntensity(quarterRange) {
            const quarterMonths = monthsBetweenInclusive(quarterRange.start, quarterRange.end);
            const dataForQuarter = fullDataSeries.filter(d => quarterMonths.includes(d.ym));
            if(dataForQuarter.length !== 3) return null;
            const totalProduction = dataForQuarter.reduce((sum, d) => sum + d.productionMTD, 0);
            const totalEmission = dataForQuarter.reduce((sum, d) => sum + d.totalAbsEmissionMTD, 0);
            return totalProduction > 0 ? (totalEmission / totalProduction) : 0;
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateMetrics(data) {
            if (!data) return;
            document.getElementById('overview-subtitle').textContent = data.overviewText;
            if (data.production) {
                updateProductionCard(data);
                document.getElementById('cs-production-period-text').textContent = data.production.periodLabel;
            }
            document.getElementById('scrap-input-value').textContent = data.scrap.value;
            document.getElementById('external-scrap').textContent = data.scrap.external;
            document.getElementById('internal-scrap').textContent = data.scrap.internal;
        }

        function updateProductionCard(data) {
            if (!data || !data.production) return;
            const unit = document.getElementById('unit-selector').value;
            const valueEl = document.getElementById('cs-production-value');
            valueEl.textContent = (unit === 'MnT') ? data.production.value : data.production.valueInTonnes.toLocaleString();
        }

        function setDynamicGreeting() {
            const greetingEl = document.getElementById('dynamic-greeting');
            if (!greetingEl) return;
            const now = new Date();
            const istOffset = 5.5 * 60 * 60 * 1000;
            const istTime = new Date(now.getTime() + istOffset);
            const istHour = istTime.getUTCHours();
            let greetingText = '', iconSvg = '';

            if (istHour >= 5 && istHour < 12) {
                greetingText = 'Good Morning';
                iconSvg = `<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            } else if (istHour >= 12 && istHour < 17) {
                greetingText = 'Good Afternoon';
                iconSvg = `<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
            } else if (istHour >= 17 && istHour < 21) {
                greetingText = 'Good Evening';
                iconSvg = `<svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10V3M12 21v-2m-7.07-2.93l1.41-1.41M4.93 4.93l1.41 1.41M21 12h-2M5 12H3m15.07 4.07l-1.41-1.41M17.66 6.34l-1.41 1.41M4 16h16"></path></svg>`;
            } else {
                greetingText = 'Good Night';
                iconSvg = `<svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;
            }
            greetingEl.innerHTML = `${iconSvg}<span>${greetingText}</span>`;
        }

        // --- CHART RENDERING ---
        function getChartColors() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            return {
                gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                ticksColor: isDarkMode ? 'white' : '#374151',
                legendColor: isDarkMode ? 'white' : '#1f2937',
            };
        }

        function renderCo2Chart(data) {
            const co2Ctx = document.getElementById('co2LineChart').getContext('2d');
            if (co2LineChartInstance) co2LineChartInstance.destroy();
            const colors = getChartColors();
            co2LineChartInstance = new Chart(co2Ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'CO2 Emissions Intensity', data: data.emissions, borderColor: 'rgb(255, 99, 132)', backgroundColor: 'rgba(255, 99, 132, 0.2)', tension: 0.4, fill: false, pointStyle: 'circle', pointRadius: 6, pointHoverRadius: 10 },
                        { label: 'Intensity Target', data: data.target, borderColor: 'rgb(75, 192, 192)', borderDash: [5, 5], tension: 0, fill: false, pointStyle: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } }
                    },
                    plugins: { 
                        legend: { 
                            position: 'top', align: 'start',
                            labels: { color: colors.legendColor, usePointStyle: true, filter: (item) => item.text !== 'Intensity Target' } 
                        } 
                    }
                }
            });
        }

        function renderDownstreamChart(data) {
            const downstreamCtx = document.getElementById('downstreamBarChart').getContext('2d');
            if (downstreamBarChartInstance) downstreamBarChartInstance.destroy();
            const colors = getChartColors();
            downstreamBarChartInstance = new Chart(downstreamCtx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'tCO₂/ton', data: data.values,
                        backgroundColor: ['rgba(255, 159, 64, 0.7)', 'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(153, 102, 255, 0.7)'],
                        borderColor: ['rgb(255, 159, 64)', 'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(153, 102, 255)'], borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor }, suggestedMax: Math.max(...data.values) * 1.2 },
                        x: { grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } }
                    },
                    plugins: { legend: { display: false } },
                    animation: {
                        onComplete: function() {
                            const chart = this; const ctx = chart.ctx;
                            ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; ctx.font = "12px 'Inter', sans-serif";
                            ctx.fillStyle = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.7)';
                            this.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((bar, index) => ctx.fillText(dataset.data[index].toFixed(2), bar.x, bar.y - 5));
                            });
                        }
                    }
                }
            });
        }

        function renderCsrDonutChart(data) {
            const csrCtx = document.getElementById('csrDonutChart').getContext('2d');
            if (csrDonutChartInstance) csrDonutChartInstance.destroy();
            const colors = getChartColors();
            csrDonutChartInstance = new Chart(csrCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.beneficiaries).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
                    datasets: [{
                        label: 'Beneficiaries', data: Object.values(data.beneficiaries),
                        backgroundColor: ['#10B981', '#3B82F6', '#8B5CF6', '#F59E0B', '#F43F5E', '#EF4444'],
                        borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff', hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: colors.legendColor, font: { size: 14 } } } }
                }
            });
        }
        
        function renderProductionChart(view){
            const wrap = document.getElementById('prodChartWrap');
            const canvas = document.getElementById('prodChart');
            if(!wrap || !canvas) return;
            wrap.classList.remove('hidden');

            const ctx = canvas.getContext('2d');
            if (prodChartInstance) prodChartInstance.destroy();
            const colors = getChartColors();

            if (view === 'ytd') {
                let allFYs = [...new Set(fullDataSeries.map(d => getFY(d.ym)))].sort();
                allFYs = allFYs.filter(fy => fy === 'FY2025' || fy === 'FY2026'); // Filter for specific FYs

                const monthNames = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
                const monthColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#8D6E63', '#EC407A', '#7E57C2', '#26A69A', '#D4E157', '#FFA726'];
                const monthMap = { Apr: 4, May: 5, Jun: 6, Jul: 7, Aug: 8, Sep: 9, Oct: 10, Nov: 11, Dec: 12, Jan: 1, Feb: 2, Mar: 3 };

                const datasets = monthNames.map((monthName, index) => {
                    const monthNum = monthMap[monthName];
                    return {
                        label: monthName,
                        data: allFYs.map(fy => {
                            const fyData = fullDataSeries.filter(d => getFY(d.ym) === fy);
                            const monthData = fyData.find(d => ymToParts(d.ym).m === monthNum);
                            return monthData ? monthData.productionMTD : 0;
                        }),
                        backgroundColor: monthColors[index],
                    };
                });

                prodChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: allFYs, datasets: datasets },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.dataset.label}: ${(ctx.raw / 1e6).toFixed(2)} MnT`
                                }
                            }
                        },
                        scales: {
                            x: { stacked: true, grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor, callback: (v) => (v / 1e6).toFixed(0) + 'M' } },
                            y: { stacked: true, grid: { color: colors.gridColor }, ticks: { color: colors.ticksColor } }
                        }
                    }
                });

            } else {
                let labels = [], data = [], bg=[], border=[];
                
                if(view === 'monthly'){
                    const idx = fullDataSeries.findIndex(d => d.ym === selectedMonthYM);
                    const i = idx >= 0 ? idx : fullDataSeries.length - 1;
                    const start = Math.max(0, i - 2);
                    const subset = fullDataSeries.slice(start, i + 1);
                    labels = subset.map(d => new Date(d.ym+'-02').toLocaleString('en-US',{month:'short'}));
                    data = subset.map(d => d.productionMTD);
                    const activeColor = '#5A95F8', lightShade = '#A9C7FB'; 
                    bg = subset.map((_,j) => j === subset.length-1 ? activeColor : lightShade);
                    border = subset.map((_,j) => j === subset.length-1 ? activeColor : lightShade);
                } else if(view === 'quarterly'){
                    const yms = monthsBetweenInclusive(lastQuarterUsed.startYM, lastQuarterUsed.endYM);
                    labels = yms.map(ym => new Date(ym+'-02').toLocaleString('en-US',{month:'short'}));
                    data = yms.map(ym => (fullDataSeries.find(r => r.ym === ym) || {ton:0}).productionMTD);
                    bg = yms.map(() => 'rgba(59,130,246,0.75)');
                    border = yms.map(() => 'rgb(59,130,246)');
                }
                
                prodChartInstance = new Chart(ctx,{
                    type:'bar', data:{ labels, datasets:[{ data, backgroundColor:bg, borderColor:border, borderWidth:1 }]},
                    options:{
                        responsive:true, maintainAspectRatio:false,
                        scales:{
                            y:{ beginAtZero:true, grid:{ color: colors.gridColor }, ticks:{ color: colors.ticksColor, callback:(v)=> (v/1e6).toFixed(1) }, suggestedMax: Math.max(...data) * 1.2 },
                            x:{ grid:{ display:false }, ticks:{ color: colors.ticksColor }}
                        },
                        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> (ctx.raw / 1e6).toFixed(2) + ' MnT' }}},
                        animation: {
                            onComplete: function() {
                                const chart = this; const ctx = chart.ctx;
                                ctx.textAlign = 'center'; ctx.textBaseline = 'bottom'; ctx.font = "12px 'Inter', sans-serif";
                                ctx.fillStyle = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.8)' : 'rgba(0, 0, 0, 0.7)';
                                this.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((bar, index) => ctx.fillText((dataset.data[index] / 1e6).toFixed(2), bar.x, bar.y - 5));
                                });
                            }
                        }
                    }
                });
            }
        }

        // --- EVENT HANDLERS & LOGIC ---
        function handleQuarterlySwitch(){
            let pastQuartersData = [];
            let currentQuarter = previousQuarterRangeForYM(selectedMonthYM);

            for (let i = 0; i < 3; i++) {
                if (currentQuarter && hasAllMonths(currentQuarter.start, currentQuarter.end)) {
                    const intensity = calculateQuarterlyIntensity(currentQuarter);
                    if (intensity !== null) {
                        pastQuartersData.unshift({ label: `${currentQuarter.fy.replace('20','')} Q${currentQuarter.q}`, intensity: intensity, range: currentQuarter });
                    }
                    currentQuarter = previousQuarterRangeForYM(currentQuarter.start);
                } else { break; }
            }
            
            if (pastQuartersData.length > 0) {
                const mostRecentQuarter = pastQuartersData[pastQuartersData.length - 1];
                dashboardData.quarterly.co2 = {
                    labels: pastQuartersData.map(q => q.label), emissions: pastQuartersData.map(q => q.intensity),
                    target: pastQuartersData.map(() => 2.09), average: mostRecentQuarter.intensity.toFixed(2), title: mostRecentQuarter.label
                };

                const { start, end, q, fy } = mostRecentQuarter.range;
                const quarterMonths = monthsBetweenInclusive(start, end);
                const dataForQuarter = fullDataSeries.filter(d => quarterMonths.includes(d.ym));
                const totalProduction = dataForQuarter.reduce((sum, d) => sum + d.productionMTD, 0);
                lastQuarterUsed = { startYM: start, endYM: end };
                
                dashboardData.quarterly.overviewText = `${fy} Q${q} Overview`;
                dashboardData.quarterly.production.valueInTonnes = +totalProduction.toFixed(2);
                dashboardData.quarterly.production.value = +(totalProduction / 1e6).toFixed(2);
                dashboardData.quarterly.production.periodLabel = `${fy} Q${q} (${rangeLabel(start, end)})`;

                updateDashboard('quarterly');
            }
        }

        function updateMonthlyFor(ym) {
            const rec = fullDataSeries.find(r => r.ym === ym);
            if (!rec) return;
            const selLabel = toMonthLabel(ym);
            dashboardData.monthly.overviewText = `${selLabel} Overview`;
            dashboardData.monthly.production.valueInTonnes = +rec.productionMTD.toFixed(2);
            dashboardData.monthly.production.value = +(rec.productionMTD / 1e6).toFixed(2);
            dashboardData.monthly.production.periodLabel = selLabel;
            updateDashboard('monthly');
        }

        // --- MAIN DASHBOARD UPDATE FUNCTION ---
        function updateDashboard(view) {
            currentDataView = view;
            document.querySelectorAll('.time-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${view}`).classList.add('active');
            
            let currentData = dashboardData[view];

            if (view === 'ytd') {
                const latestDataPoint = fullDataSeries[fullDataSeries.length - 1];
                const latestFY = getFY(latestDataPoint.ym);
                const selectedFY = getFY(selectedMonthYM);

                let ytdProductionData, ytdLabel, overviewText;
                
                const fiscalYearData = fullDataSeries.filter(d => getFY(d.ym) === selectedFY);
                
                if (selectedFY < latestFY) {
                    ytdProductionData = fiscalYearData.reduce((sum, d) => sum + d.productionMTD, 0);
                    ytdLabel = `Total for ${selectedFY}`;
                    overviewText = `${selectedFY} Overview`;
                } else {
                    ytdProductionData = fiscalYearData.reduce((sum, d) => sum + d.productionMTD, 0);
                    const latestMonthName = toMonthLabel(latestDataPoint.ym).split(' ')[0];
                    ytdLabel = `YTD for ${latestFY} (till ${latestMonthName})`;
                    overviewText = `${latestFY} YTD Overview`;
                }

                dashboardData.ytd.production.valueInTonnes = +ytdProductionData.toFixed(2);
                dashboardData.ytd.production.value = +(ytdProductionData / 1e6).toFixed(2);
                dashboardData.ytd.production.periodLabel = ytdLabel;
                dashboardData.ytd.overviewText = overviewText;
                currentData = dashboardData.ytd; // Ensure currentData reflects these changes
            }

            updateMetrics(currentData);

            let co2ChartData;
            const co2Subtitle = document.getElementById('co2-intensity-subtitle');
            const downstreamTitle = document.getElementById('downstream-chart-title');
            const csrTitle = document.getElementById('csr-chart-title');
            const insightsTitle = document.getElementById('insights-title');
            let periodLabelForTitles = '';

            if (view === 'monthly') {
                co2Subtitle.textContent = 'vs Target: 2.09 tCO₂/tcs';
                const idx = fullDataSeries.findIndex(d => d.ym === selectedMonthYM);
                const i = idx >= 0 ? idx : fullDataSeries.length - 1;
                const start = Math.max(0, i - 2); 
                const subset = fullDataSeries.slice(start, i + 1);
                
                co2ChartData = {
                    labels: subset.map(d => new Date(d.ym+'-02').toLocaleString('en-US',{month:'short'})),
                    emissions: subset.map(d => d.totalAbsEmissionMTD / d.productionMTD),
                    target: subset.map(() => 2.09) 
                };
                const latestIntensity = subset[subset.length-1].totalAbsEmissionMTD / subset[subset.length-1].productionMTD;
                document.getElementById('co2-intensity-value').textContent = latestIntensity.toFixed(2);
                periodLabelForTitles = toMonthLabel(selectedMonthYM).split(' ')[0];

            } else if (view === 'ytd') {
                const allFYs = [...new Set(fullDataSeries.map(d => getFY(d.ym)))].sort();
    
                if (allFYs.length >= 2) {
                    const latestFY = allFYs[allFYs.length - 1];
                    const previousFY = allFYs[allFYs.length - 2];

                    const previousFYData = fullDataSeries.filter(d => getFY(d.ym) === previousFY);
                    const latestFYData = fullDataSeries.filter(d => getFY(d.ym) === latestFY);

                    const previousFYTotalProd = previousFYData.reduce((sum, d) => sum + d.productionMTD, 0);
                    const previousFYTotalEmission = previousFYData.reduce((sum, d) => sum + d.totalAbsEmissionMTD, 0);
                    const previousFYIntensity = previousFYTotalEmission / previousFYTotalProd;

                    const latestFYTotalProd = latestFYData.reduce((sum, d) => sum + d.productionMTD, 0);
                    const latestFYTotalEmission = latestFYData.reduce((sum, d) => sum + d.totalAbsEmissionMTD, 0);
                    const latestFYIntensity = latestFYTotalEmission / latestFYTotalProd;

                    const latestMonthLabel = toMonthLabel(latestFYData[latestFYData.length - 1].ym).split(' ')[0];
                    co2Subtitle.textContent = `YTD ${latestFY} (till ${latestMonthLabel})`;
                    co2ChartData = {
                        labels: [previousFY, `YTD ${latestFY}`],
                        emissions: [previousFYIntensity, latestFYIntensity],
                        target: [2.09, 2.09]
                    };
                    document.getElementById('co2-intensity-value').textContent = latestFYIntensity.toFixed(2);
                } else {
                    co2ChartData = { labels: [], emissions: [], target: [] };
                    co2Subtitle.textContent = 'Not enough data for YTD comparison';
                    document.getElementById('co2-intensity-value').textContent = 'N/A';
                }
                periodLabelForTitles = currentData.overviewText.replace(' Overview', '');

            } else if (view === 'quarterly') {
                co2ChartData = currentData.co2;
                document.getElementById('co2-intensity-value').textContent = currentData.co2.average;
                co2Subtitle.textContent = `${currentData.co2.title} Average Intensity`;
                periodLabelForTitles = currentData.overviewText.replace(' Overview', '');
            }
            
            downstreamTitle.textContent = `Down Stream Emission Intensity (${periodLabelForTitles})`;
            csrTitle.textContent = `CSR Beneficiaries (${periodLabelForTitles})`;
            insightsTitle.textContent = `${periodLabelForTitles} Highlights & Insights`;

            renderCo2Chart(co2ChartData);
            const downstreamData = currentData.downstreamEmissions[currentDownstreamLocation];
            renderDownstreamChart(downstreamData);
            renderCsrDonutChart(currentData.csr);
            renderProductionChart(view);
        }

        // --- MONTH POPOVER LOGIC ---
        function buildMonthPopover() {
            const wrap = document.getElementById('month-popover-content');
            if (!wrap) return;
            wrap.innerHTML = '';
            ['FY2026','FY2025'].forEach((fy, idx) => {
                const section = document.createElement('div');
                section.className = idx === 0 ? 'mb-3' : 'mt-4';
                const h = document.createElement('div');
                h.className = 'text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2';
                h.textContent = fy;
                section.appendChild(h);
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-3 gap-2';
                
                const startYear = parseInt(fy.replace('FY','')) - 1;
                const months = Array.from({length: 12}, (_, i) => {
                    const month = (i + 3) % 12 + 1;
                    const year = startYear + Math.floor((i + 3) / 12);
                    return toYM(year, month);
                });
                const monthNames = ['Apr','May','Jun','Jul','Aug','Sept','Oct','Nov','Dec','Jan','Feb','Mar'];

                months.forEach((ym, i) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.dataset.ym = ym;
                    btn.textContent = monthNames[i];
                    btn.className = 'px-3 py-1.5 rounded-full text-sm font-semibold transition select-none';
                    if (AVAILABLE_MONTHS.has(ym)) {
                        btn.className += (ym === selectedMonthYM)
                            ? ' bg-green-500 text-white'
                            : ' text-gray-800 dark:text-gray-100 bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700';
                        btn.addEventListener('click', () => {
                            selectedMonthYM = ym;
                            if(currentDataView === 'quarterly') handleQuarterlySwitch();
                            else if (currentDataView === 'ytd') { updateDashboard('ytd'); } 
                            else updateMonthlyFor(ym);
                            buildMonthPopover();
                            closeMonthPopover();
                        });
                    } else {
                        btn.className += ' text-gray-400 bg-gray-100/40 dark:bg-gray-800/40 cursor-not-allowed';
                        btn.disabled = true;
                    }
                    grid.appendChild(btn);
                });
                section.appendChild(grid);
                wrap.appendChild(section);
            });
        }
        function closeMonthPopover() {
            document.getElementById('month-popover').classList.add('hidden');
            document.getElementById('month-popover-btn').setAttribute('aria-expanded','false');
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // Beta Overlay
            const betaOverlay = document.getElementById('beta-overlay');
            const betaModal = document.getElementById('beta-modal');
            setTimeout(() => {
                betaModal.classList.remove('scale-95', 'opacity-0');
                betaModal.classList.add('scale-100', 'opacity-100');
            }, 100);
            document.getElementById('dismiss-beta').addEventListener('click', () => {
                betaOverlay.style.opacity = 0;
                setTimeout(() => {
                    betaOverlay.style.display = 'none';
                }, 300);
            });

            // Set dynamic greeting
            setDynamicGreeting();

            // Initial dashboard render
            updateDashboard('monthly');

            // Attach event listeners
            document.getElementById('filter-monthly').addEventListener('click', () => updateDashboard('monthly'));
            document.getElementById('filter-quarterly').addEventListener('click', () => handleQuarterlySwitch());
            document.getElementById('filter-ytd').addEventListener('click', () => updateDashboard('ytd'));
            document.getElementById('unit-selector').addEventListener('change', () => updateProductionCard(dashboardData[currentDataView]));

            // Downstream filter logic
            document.getElementById('downstream-filter-container').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const location = e.target.dataset.location;
                    if (location) {
                        currentDownstreamLocation = location;
                        document.querySelectorAll('#downstream-filter-container .filter-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        const data = dashboardData[currentDataView].downstreamEmissions[location];
                        renderDownstreamChart(data);
                    }
                }
            });

            // Month popover interactions
            const monthBtn = document.getElementById('month-popover-btn');
            const monthPop = document.getElementById('month-popover');
            monthBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (monthPop.classList.contains('hidden')) {
                    buildMonthPopover();
                    monthPop.classList.remove('hidden');
                    monthBtn.setAttribute('aria-expanded','true');
                } else {
                    closeMonthPopover();
                }
            });
            document.addEventListener('click', (e) => !monthPop.classList.contains('hidden') && !monthPop.contains(e.target) && e.target !== monthBtn && closeMonthPopover());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && closeMonthPopover());

            // Download functionality
            const downloadBtn = document.getElementById('download-btn');
            const downloadMenu = document.getElementById('download-menu');
            downloadBtn.addEventListener('click', (e) => { e.stopPropagation(); downloadMenu.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => !downloadMenu.classList.contains('hidden') && !downloadMenu.contains(e.target) && e.target !== downloadBtn && downloadMenu.classList.add('hidden'));

            const captureDashboard = () => {
                const elementsToHide = [document.getElementById('beta-overlay'), downloadBtn, downloadMenu, document.getElementById('month-popover-btn'), document.getElementById('theme-toggle')];
                elementsToHide.forEach(el => el && (el.style.visibility = 'hidden'));
                return html2canvas(document.body).finally(() => elementsToHide.forEach(el => el && (el.style.visibility = 'visible')));
            }

            document.getElementById('download-png').addEventListener('click', (e) => {
                e.preventDefault();
                captureDashboard().then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'esg-pulse-monitor.png';
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
                downloadMenu.classList.add('hidden');
            });

            document.getElementById('download-pdf').addEventListener('click', (e) => {
                e.preventDefault();
                const { jsPDF } = window.jspdf;
                captureDashboard().then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save('esg-pulse-monitor.pdf');
                });
                downloadMenu.classList.add('hidden');
            });
        };
    </script>
</body>
</html>
